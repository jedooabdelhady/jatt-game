<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¬Ø§Ø·Øª ğŸ²</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --secondary: #a29bfe; --accent: #fd79a8; --dark: #2d3436; --light: #dfe6e9; --glass: rgba(255, 255, 255, 0.95); --success: #00b894; --bg-gradient: linear-gradient(135deg, #6c5ce7 0%, #0984e3 100%); --text-main: #2d3436; --card-bg: white; --input-bg: #f1f2f6; }
        body.dark-theme { --bg-gradient: linear-gradient(135deg, #2d3436 0%, #000000 100%); --glass: rgba(30, 30, 30, 0.98); --text-main: #ffffff; --card-bg: #2d3436; --input-bg: #636e72; --dark: #ffffff; }
        * { box-sizing: border-box; }
        
        body { 
            margin: 0; font-family: 'Tajawal', sans-serif; background: var(--bg-gradient); 
            min-height: 100vh; display: flex; justify-content: center; align-items: center; 
            overflow: hidden; transition: background 0.5s; -webkit-user-select: none; user-select: none;
        }

        #app-container { 
            width: 100%; max-width: 480px; height: 100dvh; background: var(--glass); 
            position: relative; overflow: hidden; display: flex; flex-direction: column; 
            transition: background 0.3s; box-shadow: none;
        }

        @media (min-width: 501px) {
            #app-container { height: 90vh; max-height: 850px; border-radius: 35px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        }

        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 25px;
            padding-top: 80px; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; overflow-y: auto; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            opacity: 0; pointer-events: none; transform: scale(0.9); z-index: 0;
        }
        .screen.active { opacity: 1; pointer-events: all; transform: scale(1); z-index: 10; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø¹Ù„ÙˆÙŠØ© */
        .top-btn { position: absolute; top: 20px; z-index: 100; background: rgba(255,255,255,0.2); border: none; font-size: 1.4rem; cursor: pointer; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.3s; backdrop-filter: blur(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: var(--text-main); }
        .top-btn:active { transform: scale(0.9); }
        .theme-btn { left: 20px; }
        .exit-btn { right: 20px; background: #ff7675; color: white; display: none; }

        /* Ø²Ø± Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .profile-circle-btn {
            position: absolute; top: 20px; right: 20px; width: 55px; height: 55px;
            background: var(--card-bg); border-radius: 50%; border: 3px solid var(--primary);
            cursor: pointer; z-index: 90; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15); transition: 0.3s;
            display: none; /* ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù‡ÙˆÙ… */
        }
        .profile-circle-btn:hover { transform: scale(1.05); }
        .profile-circle-btn svg { width: 100%; height: 100%; }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ù†ØµÙˆØµ */
        h1 { font-size: 3rem; color: var(--text-main); margin-bottom: 5px; font-weight: 900; text-align: center; letter-spacing: -1px; }
        h2 { color: var(--primary); margin-bottom: 20px; text-align: center; font-size: 1.6rem; font-weight: 800; }
        
        .card-box {
            background: var(--card-bg); padding: 25px; border-radius: 25px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; width: 100%;
            text-align: center; display: flex; flex-direction: column; align-items: center;
        }

        /* Ø§Ù„Ø£ÙØ§ØªØ§Ø± */
        .avatar-display { width: 180px; height: 180px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.15)); margin: 10px 0; }
        .avatar-display svg { width: 100%; height: 100%; overflow: visible; }
        .mini-avatar svg { width: 35px; height: 35px; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .btn-container { width: 100%; display: flex; flex-direction: column; gap: 12px; }
        .btn { 
            width: 100%; padding: 18px; border: none; border-radius: 20px; 
            font-size: 1.1rem; font-weight: 800; cursor: pointer; transition: 0.2s; 
            position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 6px 0 #4834d4; }
        .btn-secondary { background: var(--accent); color: white; box-shadow: 0 6px 0 #e84393; }
        .btn-outline { background: transparent; border: 3px solid var(--light); color: var(--text-main); box-shadow: 0 6px 0 #b2bec3; }
        .btn-danger { background: #ff7675; color: white; box-shadow: 0 6px 0 #d63031; }
        .btn:active { transform: translateY(6px); box-shadow: none !important; }

        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        .input-group { width: 100%; margin-bottom: 15px; }
        input[type="text"], input[type="number"], textarea { 
            width: 100%; padding: 16px; border: 2px solid transparent; background: var(--input-bg);
            border-radius: 18px; font-size: 1.1rem; outline: none; transition: 0.3s; 
            color: var(--text-main); text-align: center; font-family: inherit; font-weight: bold;
        }
        textarea { resize: none; height: 80px; font-size: 0.9rem; font-weight: normal; }
        input:focus, textarea:focus { border-color: var(--primary); background: var(--card-bg); box-shadow: 0 5px 15px rgba(108, 92, 231, 0.1); }

        /* Ø§Ù„Ø´Ø¨ÙƒØ§Øª ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… */
        .topics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; padding: 5px; }
        .topic-card { 
            background: var(--card-bg); color: var(--text-main); padding: 20px 10px; 
            border-radius: 20px; text-align: center; border: 2px solid transparent; 
            cursor: pointer; transition: 0.2s; font-weight: bold; font-size: 1rem; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        .topic-card.selected { border-color: var(--primary); background: #f0f3ff; color: var(--primary); transform: scale(0.98); }

        .lobby-list { width: 100%; max-height: 45vh; overflow-y: auto; padding: 5px; margin-bottom: 15px; }
        .player-chip { 
            display: flex; align-items: center; justify-content: space-between; 
            background: var(--card-bg); color: var(--text-main); padding: 10px 15px; 
            border-radius: 15px; margin-bottom: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.03); 
            font-weight: bold; 
        }

        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù„Ø¹Ø¨Ø© */
        .timer-bar { position: absolute; top: 0; left: 0; width: 100%; height: 8px; background: linear-gradient(90deg, #fab1a0, #ff7675); transform-origin: left; z-index: 20; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px; }
        .vote-btn { width: 100%; padding: 16px; margin-bottom: 10px; background: var(--card-bg); color: var(--text-main); border: 2px solid transparent; border-radius: 18px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.2s; box-shadow: 0 4px 0 #dfe6e9; }
        .vote-btn:active { transform: translateY(4px); box-shadow: none; }

        /* Ø§Ù„Ø´Ø§Øª */
        #chat-toggle-btn { position: absolute; bottom: 20px; left: 20px; z-index: 100; background: var(--primary); color: white; border: none; width: 55px; height: 55px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4); transition: 0.3s; display: none; }
        .has-new-msg::after { content: ''; position: absolute; top: 2px; right: 2px; width: 14px; height: 14px; background: #ff7675; border-radius: 50%; border: 2px solid white; }
        #chat-popup { position: absolute; bottom: 85px; left: 20px; width: 300px; height: 45vh; background: var(--card-bg); border-radius: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; z-index: 101; transform: scale(0); transform-origin: bottom left; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); overflow: hidden; border: 1px solid rgba(0,0,0,0.05); }
        #chat-popup.open { transform: scale(1); }
        .chat-msg-row.mine .chat-bubble { background: var(--primary); color: white; border-radius: 15px 15px 0 15px; }
        .chat-msg-row.theirs .chat-bubble { background: var(--input-bg); color: var(--text-main); border-radius: 15px 15px 15px 0; }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        @media (max-width: 380px) {
            h1 { font-size: 2.2rem; }
            .btn { padding: 14px; font-size: 1rem; }
            .screen { padding: 15px; padding-top: 70px; }
        }
    </style>
</head>
<body>

<div id="app-container">
    <button class="top-btn theme-btn" onclick="toggleTheme()" title="ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¸Ù‡Ø±">ğŸŒ“</button>
    <button class="top-btn exit-btn" onclick="leaveGame()" title="Ø®Ø±ÙˆØ¬">ğŸšª</button>
    
    <div id="home-profile-btn" class="profile-circle-btn" onclick="showProfile()">
        <div id="home-btn-avatar" style="width:100%; height:100%;"></div>
    </div>

    <button id="chat-toggle-btn" onclick="toggleChat()">ğŸ’¬</button>
    
    <div id="chat-popup">
        <div style="padding:15px; background:var(--primary); color:white; font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
            <span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ’¬</span>
            <span style="cursor:pointer; font-size:1.2rem;" onclick="toggleChat()">Ã—</span>
        </div>
        <div id="chat-msgs-box" style="flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; gap:8px;"></div>
        <div style="padding:10px; background:var(--card-bg); display:flex; gap:5px; border-top:1px solid #eee;">
            <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨..." onkeypress="handleChatEnter(event)" style="padding:10px; border-radius:50px;">
            <button onclick="sendChatMessage()" style="background:var(--primary); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer;">â¤</button>
        </div>
    </div>

    <div id="home-screen" class="screen active">
        <h1>Ø¬Ø§Ø·Øª ğŸ²</h1>
        <div id="my-avatar-home" class="avatar-display"></div>
        <div class="btn-container">
            <button class="btn btn-secondary" onclick="goToSetup()">ğŸ® Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
            <button class="btn btn-outline" onclick="showJoinCode()">ğŸ”‘ Ø¯Ø®ÙˆÙ„ Ø¨Ø±Ù…Ø²</button>
        </div>
        <p id="reconnect-msg" style="display:none; color:var(--primary); margin-top:15px; font-weight:bold;">Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©... â³</p>
    </div>

    <div id="profile-screen" class="screen">
        <div class="card-box" style="padding-top: 80px; position: relative; margin-top: 60px;">
            <div id="profile-avatar" class="avatar-display" style="width: 120px; height: 120px; position: absolute; top: -60px; background: var(--bg-gradient); border-radius: 50%; padding: 5px; border: 4px solid var(--card-bg);"></div>
            
            <h2 id="profile-name" style="margin: 10px 0 5px 0;">...</h2>
            <div style="background: var(--secondary); color: white; padding: 4px 15px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 15px;">Ù…Ø³ØªÙˆÙ‰ <span id="profile-lvl">1</span></div>
            
            <div class="input-group" style="margin-bottom:10px;">
                <textarea id="profile-bio" placeholder="Instagram User ... , snapchat user ..." onblur="saveBio()"></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-top: 10px;">
                <div style="background: var(--input-bg); padding: 15px; border-radius: 15px;">
                    <div style="font-size: 0.8rem; opacity: 0.7;">ÙÙˆØ² ğŸ†</div>
                    <div id="profile-wins" style="font-size: 1.4rem; font-weight: 900; color: var(--success);">0</div>
                </div>
                <div style="background: var(--input-bg); padding: 15px; border-radius: 15px;">
                    <div style="font-size: 0.8rem; opacity: 0.7;">Ù†Ù‚Ø§Ø· â­</div>
                    <div id="profile-points" style="font-size: 1.4rem; font-weight: 900; color: var(--primary);">0</div>
                </div>
            </div>
        </div>

        <div class="btn-container">
            <button class="btn btn-primary" onclick="editProfileFromProfile()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ§Ù„Ø§Ø³Ù…</button>
            <button class="btn btn-outline" onclick="goHome()">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </div>

    <div id="screen-avatar" class="screen">
        <h2>Ø£Ù†Ø§Ù‚ØªÙƒ Ù…Ø·Ù„ÙˆØ¨Ø© ğŸ˜</h2>
        <div class="avatar-preview-box" id="avatar-editor-preview" style="background: #f0f3ff; border: 4px solid var(--primary); border-radius: 30px; width: 220px; height: 240px; display:flex; justify-content:center; align-items:center; margin-bottom:20px;"></div>
        
        <div class="input-group">
            <input type="text" id="player-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±..." maxlength="12">
        </div>

        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; width:100%; margin-bottom:20px;">
            <button class="btn btn-outline" style="padding:10px; font-size:0.9rem;" onclick="changeConfig('color')">ğŸ¨ Ù„ÙˆÙ†</button>
            <button class="btn btn-outline" style="padding:10px; font-size:0.9rem;" onclick="changeConfig('face')">ğŸ‘€ ÙˆØ¬Ù‡</button>
            <button class="btn btn-outline" style="padding:10px; font-size:0.9rem;" onclick="changeConfig('hat')">ğŸ© Ù‚Ø¨Ø¹Ø©</button>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-primary" onclick="saveAvatarAndReturn()">ğŸ’¾ Ø­ÙØ¸</button>
        </div>
    </div>

    <div id="setup-screen" class="screen">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ© âš™ï¸</h2>
        <div class="card-box" style="text-align: right;">
            <div class="input-group">
                <label style="font-weight:bold; color:var(--text-main)">Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª: <span id="rounds-display" style="color:var(--primary)">5</span></label>
                <input type="range" id="rounds-setting" min="3" max="10" value="5" oninput="document.getElementById('rounds-display').innerText=this.value">
            </div>
            <div class="input-group">
                <label style="font-weight:bold; color:var(--text-main)">ÙˆÙ‚Øª Ø§Ù„ØªÙÙƒÙŠØ±: <span id="time-display" style="color:var(--primary)">30</span> Ø«</label>
                <input type="range" id="time-setting" min="15" max="60" value="30" oninput="document.getElementById('time-display').innerText=this.value">
            </div>
            <div class="input-group">
                <label style="font-weight:bold; color:var(--text-main)">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: <span id="players-display" style="color:var(--primary)">8</span></label>
                <input type="range" id="max-players" min="2" max="30" value="8" oninput="document.getElementById('players-display').innerText=this.value">
            </div>
        </div>
        <div class="btn-container">
            <button class="btn btn-secondary" onclick="goToTopicsSetup()">Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ ğŸ“‹</button>
            <button class="btn btn-outline" onclick="goHome()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="topics-setup-screen" class="screen">
        <h2>Ø¹Ù† Ù…Ø§Ø°Ø§ Ø³Ù†ÙƒØ°Ø¨ØŸ ğŸ“‚</h2>
        <div class="topics-grid" id="topics-config-grid"></div>
        <br>
        <div class="btn-container">
            <button class="btn btn-primary" onclick="createRoom()">âœ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¨Ø¯Ø¡</button>
            <button class="btn btn-outline" onclick="showScreen('setup-screen')">Ø±Ø¬ÙˆØ¹</button>
        </div>
    </div>
    
    <div id="lobby-screen" class="screen">
        <div style="text-align:center; margin-bottom:20px;">
            <span style="font-size:0.9rem; opacity:0.7;">Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</span>
            <div id="room-code-display" style="font-size:2.5rem; font-weight:900; color:var(--primary); letter-spacing:5px;">....</div>
        </div>
        
        <h3 style="align-self:flex-start; margin-right:10px;">Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ğŸ‘‡</h3>
        <div class="lobby-list" id="lobby-players"></div>
        
        <div class="btn-container">
            <div id="host-start-btn" style="display:none; width:100%"><button class="btn btn-primary" onclick="startGameFlow()">ğŸš€ Ø§Ù†Ø·Ù„Ø§Ù‚!</button></div>
            <p id="guest-wait-msg" style="display:none; color: var(--primary); text-align:center; font-weight:bold;">Ù†Ù†ØªØ¸Ø± Ø§Ù„Ù…Ø¶ÙŠÙ ÙŠØ¨Ø¯Ø£...</p>
        </div>
    </div>

    <div id="topic-screen" class="screen">
        <h2 id="chooser-msg" style="font-size:1.4rem;">...</h2>
        <div class="topics-grid" id="topics-container"></div>
    </div>

    <div id="game-screen" class="screen">
        <div class="timer-bar" id="game-timer"></div>
        <div class="card-box" style="margin-top:20px;">
            <p id="question-text" style="color: var(--text-main); font-weight: 800; font-size: 1.2rem; line-height: 1.6;">...</p>
        </div>
        <input type="text" id="answer-input" placeholder="Ø§ÙƒØªØ¨ ÙƒØ°Ø¨ØªÙƒ Ù‡Ù†Ø§..." style="margin-bottom:15px;">
        <div id="truth-msg" style="display:none; background:#d4edda; color:#155724; padding:10px; border-radius:10px; text-align:center; width:100%; margin-bottom:10px;"></div>
        
        <div id="wait-msg-game" style="display:none; text-align:center; font-weight:bold; color:var(--text-main);">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.. Ù†Ù†ØªØ¸Ø± Ø§Ù„Ø¨Ù‚ÙŠØ© ğŸ¢</div>
        
        <button id="submit-ans-btn" class="btn btn-primary" onclick="submitAnswer()">Ø¥Ø±Ø³Ø§Ù„ âœˆï¸</button>
        
        <div id="game-players-footer" style="display:flex; flex-wrap:wrap; justify-content:center; gap:8px; margin-top:20px; width:100%;"></div>
    </div>

    <div id="vote-screen" class="screen">
        <h2>ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©ØŸ ğŸ¤”</h2>
        <div id="vote-options" class="btn-container" style="margin-top:10px; margin-bottom:20px;"></div>
        <div id="vote-players-footer" style="display:flex; flex-wrap:wrap; justify-content:center; gap:8px; width:100%;"></div>
    </div>
    
    <div id="results-screen" class="screen">
        <div class="card-box" style="background:var(--success); color:white; border:none;">
            <span style="opacity:0.8; font-size:0.9rem;">Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ù‡ÙŠ:</span>
            <h2 id="truth-display" style="color:white; margin:5px 0 0 0;">...</h2>
        </div>
        <h3 style="align-self:flex-start; margin-right:10px;">Ø§Ù„ØªØ±ØªÙŠØ¨ ğŸ“Š</h3>
        <div id="leaderboard-list" class="lobby-list" style="flex-grow:1; width:100%;"></div>
        
        <div class="btn-container">
            <button id="next-round-btn" class="btn btn-primary" style="display:none;" onclick="nextStep()">Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© â¡</button>
            <p id="waiting-host-msg" style="display:none; color:var(--text-main); text-align:center;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...</p>
        </div>
    </div>

    <div id="gameover-screen" class="screen">
        <h1 style="margin-bottom:20px;">ğŸ‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ğŸ‰</h1>
        
        <div style="display:flex; width:100%; gap:15px; justify-content:center; margin-bottom:30px;">
            <div class="card-box" style="flex:1; border: 2px solid var(--success); padding:10px;">
                <h3 style="margin:0; color:var(--success)">ğŸ† Ø§Ù„Ø¨Ø·Ù„</h3>
                <div id="winner-avatar-display" style="width:80px; height:80px; margin:10px auto;"></div>
                <h2 id="winner-name" style="color:var(--text-main); font-size:1.1rem; margin:0;">...</h2>
                <span id="winner-score" style="font-weight:bold; color:var(--primary);">...</span>
            </div>

            <div class="card-box" style="flex:1; border: 2px dashed #d63031; padding:10px; background:rgba(214, 48, 49, 0.05);">
                <h3 style="margin:0; color:#d63031">ğŸ’© Ø§Ù„Ø¶Ø­ÙŠØ©</h3>
                <div id="loser-avatar-display" style="width:80px; height:80px; margin:10px auto;"></div>
                <h2 id="loser-name" style="color:var(--text-main); font-size:1.1rem; margin:0;">...</h2>
                <span id="loser-score" style="font-weight:bold; color:var(--text-main);">...</span>
            </div>
        </div>

        <div class="btn-container">
            <button id="restart-btn" class="btn btn-primary" style="display:none;" onclick="restartGame()">ğŸ”„ Ù†Ù„Ø¹Ø¨ ØªØ§Ù†ÙŠØŸ</button>
            <button class="btn btn-danger" onclick="exitGame()">ğŸ  Ø®Ø±ÙˆØ¬ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <p id="gameover-wait-msg" style="display:none; color:var(--text-main); text-align:center;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...</p>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    function toggleTheme() { document.body.classList.toggle('dark-theme'); }

    // === SVG Generator ===
    const colors = ['#FF9F43', '#54a0ff', '#5f27cd', '#ff6b6b', '#1dd1a1', '#feca57', '#fd79a8', '#00cec9', '#6D214F', '#2d3436', '#badc58'];
    let avatarConfig = { color: 0, face: 0, hat: 0 };
    const hats = [ `<g transform="translate(50, -5) scale(1.1)"><path d="M-35 20 Q-45 5 -25 0" stroke="#3d3d3d" stroke-width="3" fill="#f1f2f6"/><path d="M35 20 Q45 5 25 0" stroke="#3d3d3d" stroke-width="3" fill="#f1f2f6"/><path d="M-25 30 Q-25 5 0 5 Q25 5 25 30" fill="#cd6133" stroke="#3d3d3d" stroke-width="3"/><path d="M-28 30 L28 30 L28 35 L-28 35 Z" fill="#b2bec3" stroke="#3d3d3d" stroke-width="3"/><path d="M-5 35 L-5 5 L5 5 L5 35 Z" fill="#b2bec3" stroke="#3d3d3d" stroke-width="3"/></g>`, ``, `<g transform="translate(50, -10)"><path d="M-20 25 L-20 5 L-10 20 L0 5 L10 20 L20 5 L20 25 Z" fill="#feca57" stroke="#3d3d3d" stroke-width="3"/></g>`, `<g transform="translate(50, -15)"><rect x="-2" y="0" width="4" height="15" fill="#1dd1a1" stroke="#3d3d3d" stroke-width="2"/><circle cx="5" cy="20" r="10" fill="#ff6b6b" stroke="#3d3d3d" stroke-width="3"/><circle cx="-5" cy="22" r="10" fill="#ff6b6b" stroke="#3d3d3d" stroke-width="3"/></g>`, `<g transform="translate(50, -10)"><path d="M-25 25 L25 25 L30 15 L-30 15 Z" fill="#2d3436" stroke="#3d3d3d" stroke-width="3"/><path d="M-25 15 Q-25 -5 0 -5 Q25 -5 25 15" fill="#0984e3" stroke="#3d3d3d" stroke-width="3"/><circle cx="0" cy="10" r="5" fill="#feca57"/></g>`, `<g transform="translate(50, -20)"><rect x="-25" y="20" width="50" height="5" fill="#2d3436" stroke="#3d3d3d"/><path d="M-15 20 L-10 -10 L10 -10 L15 20 Z" fill="#2d3436" stroke="#3d3d3d" stroke-width="2"/><rect x="-15" y="15" width="30" height="5" fill="#d63031"/></g>`, `<g transform="translate(50, -10)"><path d="M-35 15 Q0 25 35 15 L30 5 Q0 10 -30 5 Z" fill="#8B4513" stroke="#3d3d3d" stroke-width="2"/><rect x="-15" y="0" width="30" height="15" fill="#8B4513" stroke="#3d3d3d"/><rect x="-15" y="10" width="30" height="5" fill="#6D214F"/></g>`, `<g transform="translate(50, 0)"><path d="M-30 30 Q-30 -10 30 30" fill="none" stroke="#3d3d3d" stroke-width="6"/><rect x="-38" y="20" width="12" height="25" rx="5" fill="#74b9ff" stroke="#3d3d3d" stroke-width="2"/><rect x="26" y="20" width="12" height="25" rx="5" fill="#74b9ff" stroke="#3d3d3d" stroke-width="2"/></g>`, `<g transform="translate(50, -15)"><path d="M0 20 Q5 5 15 0 Q5 5 0 20 Q-5 5 -15 0 Q-5 5 0 20" fill="#badc58" stroke="#3d3d3d" stroke-width="2"/><rect x="-8" y="20" width="16" height="12" fill="#e17055" stroke="#3d3d3d" stroke-width="2"/></g>` ];
    const faces = [ `<g transform="translate(50, 35)"><path d="M-20 0 Q-10 10 0 0 Z" fill="white" stroke="#3d3d3d" stroke-width="2.5" transform="translate(-10, 0) scale(1.5)"/><path d="M-20 0 Q-10 10 0 0 Z" fill="white" stroke="#3d3d3d" stroke-width="2.5" transform="translate(25, 0) scale(1.5) flip"/><circle cx="-18" cy="3" r="2" fill="black"/><circle cx="18" cy="3" r="2" fill="black"/><path d="M-15 20 L-10 15 L-5 20 L0 15 L5 20 L10 15 L15 20" fill="none" stroke="#3d3d3d" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></g>`, `<g transform="translate(50, 40)"><circle cx="-15" cy="0" r="4" fill="black"/><circle cx="15" cy="0" r="4" fill="black"/><path d="M-5 10 Q0 15 5 10" fill="none" stroke="black" stroke-width="3" stroke-linecap="round"/></g>`, `<g transform="translate(50, 40)"><circle cx="-15" cy="0" r="3" fill="black"/><circle cx="15" cy="0" r="3" fill="black"/><ellipse cx="0" cy="15" rx="5" ry="8" fill="black"/></g>`, `<g transform="translate(50, 40)"><path d="M-25 -5 L-5 -5 L-5 5 L-20 10 Z" fill="black"/><path d="M25 -5 L5 -5 L5 5 L20 10 Z" fill="black"/><rect x="-5" y="-3" width="10" height="2" fill="black"/><path d="M-10 15 Q0 20 10 15" fill="none" stroke="black" stroke-width="3"/></g>`, `<g transform="translate(50, 40)"><path d="M-20 0 L-10 -5 L0 0" fill="none" stroke="black" stroke-width="3"/><path d="M0 0 L10 -5 L20 0" fill="none" stroke="black" stroke-width="3"/><path d="M-10 15 Q0 25 10 15" fill="none" stroke="black" stroke-width="3"/></g>`, `<g transform="translate(50, 42)"><circle cx="-15" cy="-5" r="3" fill="black"/><circle cx="15" cy="-5" r="3" fill="black"/><path d="M-5 10 Q-15 10 -20 0 Q-10 5 0 10 Q10 5 20 0 Q15 10 5 10 Z" fill="#2d3436" stroke="black" stroke-width="1"/></g>`, `<g transform="translate(50, 38)"><circle cx="0" cy="5" r="14" fill="white" stroke="black" stroke-width="2"/><circle cx="0" cy="5" r="6" fill="black"/><path d="M-8 25 Q0 20 8 25" fill="none" stroke="black" stroke-width="3"/></g>`, `<g transform="translate(50, 40)"><circle cx="-15" cy="0" r="3" fill="black"/><circle cx="15" cy="0" r="3" fill="black"/><path d="M-15 5 L-15 15" stroke="#74b9ff" stroke-width="3"/><path d="M15 5 L15 15" stroke="#74b9ff" stroke-width="3"/><path d="M-8 20 Q0 15 8 20" fill="none" stroke="black" stroke-width="3"/></g>` ];

    function generateSVG(config) {
        const color = colors[config.color % colors.length];
        const hat = hats[config.hat % hats.length] || '';
        const face = faces[config.face % faces.length];
        return `<svg viewBox="0 -30 100 150" xmlns="http://www.w3.org/2000/svg"><g transform="translate(0, 10)"><ellipse cx="50" cy="95" rx="30" ry="8" fill="rgba(0,0,0,0.15)" /><path d="M18 60 Q10 70 12 80 Q15 85 25 75" fill="${color}" stroke="#3d3d3d" stroke-width="3"/><path d="M82 60 Q90 70 88 80 Q85 85 75 75" fill="${color}" stroke="#3d3d3d" stroke-width="3"/><path d="M 25 30 Q 25 0 50 0 Q 75 0 75 30 L 75 70 Q 75 90 65 90 L 60 90 L 60 105 Q 60 110 50 110 Q 40 110 40 105 L 40 90 L 35 90 Q 25 90 25 70 Z" fill="${color}" stroke="#3d3d3d" stroke-width="3" stroke-linejoin="round"/><ellipse cx="50" cy="45" rx="22" ry="18" fill="#ffdbac" stroke="#3d3d3d" stroke-width="0"/>${face}${hat}</g></svg>`;
    }

    // === Global Vars ===
    const socket = io();
    const sounds = { click: new Audio('sounds/click.mp3'), join: new Audio('sounds/join.mp3'), start: new Audio('sounds/start.mp3'), win: new Audio('sounds/win.mp3'), lose: new Audio('sounds/lose.mp3'), cheer: new Audio('sounds/cheer.mp3'), timer: new Audio('sounds/timer.mp3'), msg: new Audio('sounds/click.mp3') };
    function playSound(name) { if(sounds[name]) { sounds[name].currentTime=0; sounds[name].play().catch(e=>{}); } }
    document.addEventListener('click', (e)=>{ if(e.target.tagName==='BUTTON'||e.target.classList.contains('vote-btn')) playSound('click'); });

    let currentRoomCode = null, myName = '', amIHost = false, timerSoundTimeout;
    let allPlayersData = [];
    let isEditingFromProfile = false;

    // === PROFILE SYSTEM ===
    let userStats = { wins: 0, totalPoints: 0, gamesPlayed: 0, level: 1, bio: "" };
    let myCurrentSessionScore = 0;

    function loadStats() {
        const saved = localStorage.getItem('jatt_stats');
        if (saved) userStats = JSON.parse(saved);
        calculateLevel();
    }
    function saveStats() { localStorage.setItem('jatt_stats', JSON.stringify(userStats)); }
    function saveBio() { userStats.bio = document.getElementById('profile-bio').value; saveStats(); }
    function calculateLevel() { userStats.level = Math.floor(userStats.totalPoints / 50) + 1; }

    function showProfile() {
        loadStats();
        calculateLevel();
        document.getElementById('profile-avatar').innerHTML = generateSVG(avatarConfig);
        document.getElementById('profile-name').innerText = myName || 'Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯';
        document.getElementById('profile-bio').value = userStats.bio || "";
        document.getElementById('profile-lvl').innerText = userStats.level;
        document.getElementById('profile-wins').innerText = userStats.wins;
        document.getElementById('profile-points').innerText = userStats.totalPoints;
        showScreen('profile-screen');
    }

    function editProfileFromProfile() {
        isEditingFromProfile = true;
        document.getElementById('player-name-input').value = myName;
        renderEditor();
        showScreen('screen-avatar');
    }

    function saveAvatarAndReturn() {
        const name = document.getElementById('player-name-input').value; 
        if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ!"); 
        myName = name; 
        sessionStorage.setItem('player_name', myName);
        sessionStorage.setItem('avatar_config', JSON.stringify(avatarConfig));
        
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù‡ÙˆÙ…
        renderEditor();

        if(isEditingFromProfile) {
            isEditingFromProfile = false;
            showProfile();
        } else {
            goHome();
        }
    }

    function renderEditor() {
        document.getElementById('avatar-editor-preview').innerHTML = generateSVG(avatarConfig);
        const homeAvatar = document.getElementById('my-avatar-home');
        if(homeAvatar) homeAvatar.innerHTML = generateSVG(avatarConfig);
        
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù‡ÙˆÙ… Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ
        document.getElementById('home-btn-avatar').innerHTML = generateSVG(avatarConfig);
    }
    function changeConfig(type) { if(type === 'color') avatarConfig.color++; if(type === 'face') avatarConfig.face++; if(type === 'hat') avatarConfig.hat++; renderEditor(); }

    // === TOPICS ===
    const allTopics = [
        {id:'sudanese', label:'Ø³ÙˆØ¯Ø§Ù†ÙŠØ§Øª', icon:'ğŸ‡¸ğŸ‡©'}, {id:'football', label:'ÙƒØ±Ø© Ù‚Ø¯Ù…', icon:'âš½'}, {id:'movies', label:'Ø§ÙÙ„Ø§Ù…', icon:'ğŸ¬'},
        {id:'history', label:'ØªØ§Ø±ÙŠØ®', icon:'ğŸ“œ'}, {id:'science', label:'Ø¹Ù„ÙˆÙ…', icon:'ğŸ§ª'}, {id:'geography', label:'Ø¬ØºØ±Ø§ÙÙŠØ§', icon:'ğŸŒ'},
        {id:'flags', label:'Ø§Ø¹Ù„Ø§Ù…', icon:'ğŸ'}, {id:'tech', label:'ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§', icon:'ğŸ’»'}, {id:'anime', label:'Ø§Ù†Ù…ÙŠ', icon:'ğŸœ'},
        {id:'arts', label:'ÙÙ†ÙˆÙ†', icon:'ğŸ¨'}, {id:'variety', label:'Ù…Ù†ÙˆØ¹Ø§Øª', icon:'ğŸ²'}, {id:'math', label:'Ø°ÙƒØ§Ø¡', icon:'â•'},
        {id:'weird', label:'ØºØ±ÙŠØ¨Ø©', icon:'ğŸ¤ª'}, {id:'guinness', label:'ØºÙŠÙ†ÙŠØ³', icon:'ğŸ†'}, {id:'inventors', label:'Ù…Ø®ØªØ±Ø¹ÙŠÙ†', icon:'ğŸ’¡'},
        {id:'songs', label:'Ø§ØºØ§Ù†ÙŠ', icon:'ğŸµ'}
    ];
    let selectedTopics = [];

    // === STARTUP & RECOVERY ===
    window.addEventListener('load', () => {
        loadStats();
        const savedName = sessionStorage.getItem('player_name');
        const savedAvatar = sessionStorage.getItem('avatar_config');
        const savedRoom = sessionStorage.getItem('room_code');
        
        if (savedName) { myName = savedName; document.getElementById('player-name-input').value = myName; }
        if (savedAvatar) { avatarConfig = JSON.parse(savedAvatar); }
        
        renderEditor();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙÙŠ Ø§Ù„Ù‡ÙˆÙ… ÙÙ‚Ø·
        document.getElementById('home-profile-btn').style.display = 'block';

        if (savedRoom && savedName) {
            document.getElementById('reconnect-msg').style.display = 'block';
            setTimeout(() => socket.emit('rejoin_game', { roomCode: savedRoom, name: savedName, avatarConfig }), 500);
        }
    });

    // === NAVIGATION ===
    function showScreen(id) { 
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        
        // Ø¥Ø¯Ø§Ø±Ø© Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
        const exitBtn = document.querySelector('.exit-btn');
        const homeProfileBtn = document.getElementById('home-profile-btn');
        const isHome = (id === 'home-screen');
        
        if(isHome) {
            homeProfileBtn.style.display = 'block';
            exitBtn.style.display = 'none';
        } else {
            homeProfileBtn.style.display = 'none';
            if(id !== 'screen-avatar' && id !== 'profile-screen' && id !== 'name-input-screen' && id !== 'setup-screen' && id !== 'topics-setup-screen') {
                exitBtn.style.display = 'block';
            } else {
                exitBtn.style.display = 'none';
            }
        }
    }

    function goHome() { showScreen('home-screen'); renderEditor(); }
    function goToSetup() { if(!myName) return alert("ØµÙ…Ù… Ø´Ø®ØµÙŠØªÙƒ Ø£ÙˆÙ„Ø§Ù‹!"); showScreen('setup-screen'); }
    function goToTopicsSetup() {
        const grid = document.getElementById('topics-config-grid'); grid.innerHTML = '';
        allTopics.forEach(t => {
            const div = document.createElement('div'); div.className = 'topic-card selected'; div.innerText = t.icon+' '+t.label; div.dataset.id = t.id;
            div.onclick = () => div.classList.toggle('selected'); grid.appendChild(div);
        }); showScreen('topics-setup-screen');
    }
    function createRoom() {
        selectedTopics = []; document.querySelectorAll('#topics-config-grid .selected').forEach(el => selectedTopics.push(el.dataset.id));
        if(selectedTopics.length === 0) return alert("Ø§Ø®ØªØ± Ù…ÙˆØ¶ÙˆØ¹Ø§Ù‹!"); 
        socket.emit('create_private_room', { name: myName, avatarConfig });
    }
    function showJoinCode() { if(!myName) return alert("ØµÙ…Ù… Ø´Ø®ØµÙŠØªÙƒ!"); let code = prompt("Ø§Ù„ÙƒÙˆØ¯:"); if(code) socket.emit('join_room', { code, name: myName, avatarConfig }); }

    // === SOCKET EVENTS ===
    socket.on('rejoin_success', (data) => {
        document.getElementById('reconnect-msg').style.display = 'none';
        currentRoomCode = data.roomCode; myName = data.name; amIHost = data.isHost; allPlayersData = data.players;
        document.getElementById('chat-toggle-btn').style.display = 'block';
        restoreGameState(data);
    });

    socket.on('go_to_setup', (code) => { 
        currentRoomCode = code; sessionStorage.setItem('room_code', code); 
        document.getElementById('chat-toggle-btn').style.display = 'block'; 
        socket.emit('save_settings', { roomCode: code, settings: { rounds: document.getElementById('rounds-setting').value, time: document.getElementById('time-setting').value, maxPlayers: document.getElementById('max-players').value, topics: selectedTopics } }); 
    });

    socket.on('update_lobby', (data) => {
        if(document.getElementById('lobby-players').children.length < data.players.length) playSound('join');
        currentRoomCode = data.code; sessionStorage.setItem('room_code', data.code);
        document.getElementById('chat-toggle-btn').style.display = 'block';
        showScreen('lobby-screen');
        document.getElementById('room-code-display').innerText = data.code;
        const list = document.getElementById('lobby-players'); list.innerHTML = '';
        amIHost = (socket.id === data.hostId || (data.players.find(p=>p.id===socket.id)?.isHost));
        allPlayersData = data.players;
        data.players.forEach(p => {
            list.innerHTML += `<div class="player-chip"><div style="display:flex; align-items:center; gap:10px;"><div class="mini-avatar">${generateSVG(p.avatarConfig||{color:0})}</div><span>${p.name} ${p.isHost?'ğŸ‘‘':''}</span></div></div>`;
        });
        if (amIHost) { document.getElementById('host-start-btn').style.display='block'; document.getElementById('guest-wait-msg').style.display='none'; }
        else { document.getElementById('host-start-btn').style.display='none'; document.getElementById('guest-wait-msg').style.display='block'; }
    });

    function startGameFlow() { socket.emit('start_game_flow', currentRoomCode); }

    socket.on('choose_topic_phase', (data) => {
        showScreen('topic-screen'); 
        const cont = document.getElementById('topics-container'); cont.innerHTML = '';
        if (socket.id === data.chooserId) {
            document.getElementById('chooser-msg').innerText = "Ø¯ÙˆØ±Ùƒ ØªØ®ØªØ§Ø± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ ğŸ«µ";
            data.availableTopics.forEach(tid => {
                const t = allTopics.find(x => x.id === tid);
                if(t) { const btn = document.createElement('div'); btn.className = 'topic-card'; btn.innerText = t.icon+' '+t.label; btn.onclick = () => socket.emit('topic_selected', { roomCode: currentRoomCode, topic: tid }); cont.appendChild(btn); }
            });
        } else document.getElementById('chooser-msg').innerText = `Ù†Ù†ØªØ¸Ø± ${data.chooserName} ÙŠØ®ØªØ§Ø±...`;
    });

    socket.on('start_round', (data) => {
        playSound('start'); showScreen('game-screen');
        document.getElementById('question-text').innerHTML = data.question;
        const inputField = document.getElementById('answer-input'); inputField.value = '';
        if(data.inputType === 'number') { inputField.type = 'number'; inputField.placeholder = "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…..."; } else { inputField.type = 'text'; inputField.placeholder = "Ø£Ù„Ù ÙƒØ°Ø¨Ø© Ù…Ù‚Ù†Ø¹Ø©..."; }
        document.getElementById('truth-msg').style.display = 'none'; document.getElementById('wait-msg-game').style.display = 'none'; document.getElementById('submit-ans-btn').style.display = 'block';
        
        const footer = document.getElementById('game-players-footer'); footer.innerHTML='';
        allPlayersData.forEach(p => footer.innerHTML+=`<div class="footer-player" id="game-fp-${p.id}"><div class="footer-avatar mini-avatar">${generateSVG(p.avatarConfig)}</div><div class="status-check">âœ”</div><div class="footer-name">${p.name}</div></div>`);

        const bar = document.getElementById('game-timer'); bar.style.transition = 'none'; bar.style.width = '100%';
        clearTimeout(timerSoundTimeout); sounds.timer.pause(); sounds.timer.currentTime=0;
        setTimeout(() => { bar.style.transition = `width ${data.time}s linear`; bar.style.width = '0%'; if(data.time > 5) timerSoundTimeout = setTimeout(() => playSound('timer'), (data.time-5)*1000); }, 100);
    });

    function submitAnswer() {
        const ans = document.getElementById('answer-input').value;
        if(ans) socket.emit('submit_answer', { roomCode: currentRoomCode, answer: ans });
    }

    socket.on('player_done', (id) => document.getElementById(`game-fp-${id}`)?.classList.add('done'));
    socket.on('wait_for_others', () => { document.getElementById('wait-msg-game').style.display='block'; document.getElementById('submit-ans-btn').style.display='none'; });
    socket.on('truth_detected', (msg) => { playSound('win'); document.getElementById('truth-msg').innerText=msg; document.getElementById('truth-msg').style.display='block'; });

    socket.on('voting_phase', (data) => {
        clearTimeout(timerSoundTimeout); sounds.timer.pause(); showScreen('vote-screen');
        const list = document.getElementById('vote-options'); list.innerHTML = '';
        data.options.forEach(opt => {
            const btn = document.createElement('button'); btn.className = 'vote-btn'; btn.innerText = opt.text;
            btn.onclick = () => { socket.emit('submit_vote', { roomCode: currentRoomCode, choiceData: opt }); document.querySelectorAll('.vote-btn').forEach(b => b.style.opacity='0.5'); btn.style.opacity='1'; btn.style.borderColor='var(--primary)'; btn.style.color='var(--primary)'; };
            list.appendChild(btn);
        });
        const footer = document.getElementById('vote-players-footer'); footer.innerHTML='';
        allPlayersData.forEach(p => footer.innerHTML+=`<div class="footer-player" id="vote-fp-${p.id}"><div class="footer-avatar mini-avatar">${generateSVG(p.avatarConfig)}</div><div class="status-check">âœ”</div><div class="footer-name">${p.name}</div></div>`);
    });

    socket.on('player_voted', (id) => document.getElementById(`vote-fp-${id}`)?.classList.add('done'));

    socket.on('show_results', (data) => {
        showScreen('results-screen');
        document.getElementById('truth-display').innerText = data.truth;
        const list = document.getElementById('leaderboard-list'); list.innerHTML = '';
        let myChange = 0;
        data.leaderboard.forEach((p, i) => {
            if(p.id === socket.id) myChange = p.lastPoints;
            list.innerHTML += `<div class="leaderboard-item"><div style="display:flex; align-items:center; gap:10px;"><b>#${i+1}</b><div class="mini-avatar">${generateSVG(p.avatarConfig)}</div><span>${p.name}</span></div><div>${p.lastPoints>0?`<span style="color:var(--success)">+${p.lastPoints}</span>`:''} <b>${p.score}</b></div></div>`;
        });
        if(myChange > 0) { playSound('win'); myCurrentSessionScore+=myChange; } else playSound('lose');
        
        const btn = document.getElementById('next-round-btn'); const wait = document.getElementById('waiting-host-msg');
        if(socket.id === data.hostId) { btn.style.display = 'block'; wait.style.display = 'none'; btn.innerText = data.isFinal ? "ğŸ”¥ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ§Ø¦Ø²" : "Ø§Ù„ØªØ§Ù„ÙŠ â¡"; btn.onclick = () => socket.emit('next_step', currentRoomCode); }
        else { btn.style.display = 'none'; wait.style.display = 'block'; wait.innerText = data.isFinal ? "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬..." : "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ..."; }
    });

    socket.on('game_over', (data) => {
        playSound('cheer'); showScreen('gameover-screen'); confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        document.getElementById('winner-name').innerText = data.winner.name; document.getElementById('winner-score').innerText = `${data.winner.score} Ù†Ù‚Ø·Ø©`; document.getElementById('winner-avatar-display').innerHTML = generateSVG(data.winner.avatarConfig);
        document.getElementById('loser-name').innerText = data.loser.name; document.getElementById('loser-score').innerText = `${data.loser.score} Ù†Ù‚Ø·Ø©`; document.getElementById('loser-avatar-display').innerHTML = generateSVG(data.loser.avatarConfig);
        
        userStats.gamesPlayed++; userStats.totalPoints += myCurrentSessionScore;
        if(data.winner.id === socket.id) userStats.wins++;
        calculateLevel(); saveStats(); myCurrentSessionScore = 0;
        sessionStorage.removeItem('room_code');

        if(socket.id === data.hostId) { document.getElementById('restart-btn').style.display='block'; document.getElementById('gameover-wait-msg').style.display='none'; }
        else { document.getElementById('restart-btn').style.display='none'; document.getElementById('gameover-wait-msg').style.display='block'; }
    });

    function restartGame() { socket.emit('restart_game', currentRoomCode); }
    function leaveGame() { if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) { socket.emit('leave_game', currentRoomCode); exitGame(); } }
    function exitGame() { sessionStorage.removeItem('room_code'); location.reload(); }
    socket.on('error_msg', msg => alert(msg));

    // === Chat ===
    function toggleChat() { document.getElementById('chat-popup').classList.toggle('open'); document.getElementById('chat-toggle-btn').classList.remove('has-new-msg'); if(document.getElementById('chat-popup').classList.contains('open')) document.getElementById('chat-input').focus(); }
    function sendChatMessage() { const inp = document.getElementById('chat-input'); if(inp.value.trim() && currentRoomCode) { socket.emit('send_chat', { roomCode: currentRoomCode, message: inp.value.trim() }); inp.value = ''; } }
    function handleChatEnter(e) { if(e.key === 'Enter') sendChatMessage(); }
    socket.on('receive_chat', (data) => {
        const box = document.getElementById('chat-msgs-box');
        const div = document.createElement('div'); div.className = `chat-msg-row ${data.senderId===socket.id?'mine':'theirs'}`;
        div.innerHTML = `${data.senderId!==socket.id?`<div class="chat-sender">${data.senderName}</div>`:''}<div class="chat-bubble">${data.message}</div>`;
        box.appendChild(div); box.scrollTop = box.scrollHeight;
        if(!document.getElementById('chat-popup').classList.contains('open')) { document.getElementById('chat-toggle-btn').classList.add('has-new-msg'); playSound('msg'); }
    });

    function restoreGameState(data) {
        if (data.gameState === 'lobby') { showScreen('lobby-screen'); updateLobbyUI({ code: data.roomCode, players: data.players, hostId: data.hostId }); }
        else if (data.gameState === 'picking_topic') { showScreen('topic-screen'); handleTopicPhase(data.topicData); }
        else if (data.gameState === 'input') {
            showScreen('game-screen'); document.getElementById('question-text').innerHTML = data.questionData.question;
            const inputField = document.getElementById('answer-input');
            if(data.questionData.inputType === 'number') { inputField.type = 'number'; inputField.placeholder = "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…..."; } else { inputField.type = 'text'; inputField.placeholder = "Ø£Ù„Ù ÙƒØ°Ø¨Ø©..."; }
            if(data.hasAnswered) { document.getElementById('wait-msg-game').style.display='block'; document.getElementById('submit-ans-btn').style.display='none'; }
        } else if (data.gameState === 'voting') { showScreen('vote-screen'); renderVotingOptions(data.voteOptions); }
        else if (data.gameState === 'results') { showResultsUI(data.resultData); }
    }
</script>
</body>
</html>