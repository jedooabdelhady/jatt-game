<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¬Ø§Ø·Øª ğŸ²</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --secondary: #a29bfe; --accent: #fd79a8; --dark: #2d3436; --light: #dfe6e9; --glass: rgba(255, 255, 255, 0.98); --success: #00b894; --bg-gradient: linear-gradient(135deg, #6c5ce7 0%, #0984e3 100%); --text-main: #2d3436; --card-bg: white; --input-bg: #f1f2f6; --insta: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); --snap: #FFFC00; }
        body.dark-theme { --bg-gradient: linear-gradient(135deg, #2d3436 0%, #000000 100%); --glass: rgba(30, 30, 30, 0.98); --text-main: #ffffff; --card-bg: #2d3436; --input-bg: #636e72; --dark: #ffffff; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Tajawal', sans-serif; background: var(--bg-gradient); min-height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; transition: background 0.5s; -webkit-user-select: none; user-select: none; }
        #app-container { width: 100%; max-width: 480px; height: 100dvh; background: var(--glass); position: relative; overflow: hidden; display: flex; flex-direction: column; transition: background 0.3s; box-shadow: none; }
        @media (min-width: 501px) { #app-container { height: 90vh; max-height: 850px; border-radius: 35px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); } }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 25px; padding-top: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; transition: all 0.4s; opacity: 0; pointer-events: none; transform: scale(0.9); z-index: 0; }
        .screen.active { opacity: 1; pointer-events: all; transform: scale(1); z-index: 10; }
        .top-btn { position: absolute; top: 20px; z-index: 100; background: rgba(255,255,255,0.2); border: none; font-size: 1.4rem; cursor: pointer; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.3s; backdrop-filter: blur(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: var(--text-main); }
        .theme-btn { left: 20px; } .exit-btn { right: 20px; background: #ff7675; color: white; display: none; }
        .profile-circle-btn { position: absolute; top: 20px; right: 20px; width: 55px; height: 55px; background: var(--card-bg); border-radius: 50%; border: 3px solid var(--primary); cursor: pointer; z-index: 90; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.15); transition: 0.3s; display: none; }
        .profile-circle-btn:hover { transform: scale(1.05); } 
        .profile-circle-btn svg { width: 100%; height: 100%; display: block; }
        .avatar-preview-box { width: 220px; height: 240px; background: #f0f3ff; border-radius: 30px; border: 4px solid var(--primary); display: flex; justify-content: center; align-items: center; margin-bottom: 20px; overflow: visible; box-shadow: inset 0 0 15px rgba(0,0,0,0.05); flex-shrink: 0; }
        .avatar-preview-box svg { width: 100%; height: 100%; filter: drop-shadow(0 8px 12px rgba(0,0,0,0.15)); }
        .home-avatar-box { width: 160px; height: 180px; margin: 10px auto; display: flex; justify-content: center; align-items: center; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2)); flex-shrink: 0; }
        .home-avatar-box svg { width: 100%; height: 100%; overflow: visible; }
        .winner-avatar-box { width: 100px; height: 120px; margin: 5px auto; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .winner-avatar-box svg { width: 100%; height: 100%; overflow: visible; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); }
        .mini-avatar svg { width: 35px; height: 35px; }
        h1 { font-size: 3rem; color: var(--text-main); margin-bottom: 5px; font-weight: 900; text-align: center; } 
        h2 { color: var(--primary); margin-bottom: 20px; text-align: center; font-size: 1.6rem; font-weight: 800; }
        .card-box { background: var(--card-bg); padding: 20px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 15px; width: 100%; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .btn-container { width: 100%; display: flex; flex-direction: column; gap: 10px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 20px; font-size: 1.1rem; font-weight: 800; cursor: pointer; transition: 0.2s; display:flex; align-items:center; justify-content:center; gap: 10px; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 6px 0 #4834d4; }
        .btn-secondary { background: var(--accent); color: white; box-shadow: 0 6px 0 #e84393; }
        .btn-outline { background: transparent; border: 3px solid var(--light); color: var(--text-main); box-shadow: 0 6px 0 #b2bec3; }
        .btn-danger { background: #ff7675; color: white; box-shadow: 0 6px 0 #d63031; } .btn:active { transform: translateY(6px); box-shadow: none !important; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; background: #ccc; box-shadow:none; transform:none;}
        .input-group { width: 100%; margin-bottom: 15px; text-align: center; }
        input[type="text"], input[type="number"], textarea { width: 100%; padding: 14px; border: 2px solid transparent; background: var(--input-bg); border-radius: 18px; font-size: 1.1rem; outline: none; transition: 0.3s; color: var(--text-main); text-align: center; font-family: inherit; font-weight: bold; }
        textarea { resize: none; height: 70px; font-size: 0.9rem; font-weight: normal; } input:focus, textarea:focus { border-color: var(--primary); background: var(--card-bg); }
        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; margin: 10px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 25px; width: 25px; border-radius: 50%; background: var(--primary); cursor: pointer; margin-top: -8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: #dfe6e9; border-radius: 5px; }
        .social-input { display: flex; align-items: center; gap: 10px; background: var(--input-bg); border-radius: 18px; padding: 5px 15px; margin-bottom: 8px; width: 100%; }
        .social-input i { font-size: 1.4rem; }
        .social-input input { background: transparent; padding: 10px; font-size: 0.9rem; text-align: left; border: none; box-shadow: none; font-weight: normal; width: 100%; }
        .topics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; padding: 5px; }
        .topic-card { background: var(--card-bg); color: var(--text-main); padding: 20px 10px; border-radius: 20px; text-align: center; border: 2px solid transparent; cursor: pointer; transition: 0.2s; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .topic-card.selected { border-color: var(--primary); background: #f0f3ff; color: var(--primary); transform: scale(0.98); }
        .lobby-list { width: 100%; max-height: 45vh; overflow-y: auto; padding: 5px; margin-bottom: 15px; }
        .player-chip { display: flex; align-items: center; justify-content: space-between; background: var(--card-bg); color: var(--text-main); padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.03); font-weight: bold; cursor: pointer; transition: 0.2s; }
        .timer-bar { position: absolute; top: 0; left: 0; width: 100%; height: 8px; background: linear-gradient(90deg, #fab1a0, #ff7675); transform-origin: left; z-index: 20; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px; }
        .vote-btn { width: 100%; padding: 16px; margin-bottom: 10px; background: var(--card-bg); color: var(--text-main); border: 2px solid transparent; border-radius: 18px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.2s; box-shadow: 0 4px 0 #dfe6e9; } 
        .vote-btn:active { transform: translateY(4px); box-shadow: none; }
        .vote-btn:disabled { opacity: 0.5; cursor: default; transform: none; box-shadow: none; }
        .leaderboard-item { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); color: var(--text-main); padding: 12px; border-radius: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        #truth-msg { background: #d4edda; color: #155724; padding: 10px; border-radius: 10px; margin-top: 10px; border: 1px solid #c3e6cb; display: none; font-weight: bold; font-size: 0.9rem; text-align: center; width: 100%; }
        .game-footer { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 20px; width: 100%; background: var(--card-bg); padding: 10px; border-radius: 15px; border: 1px solid rgba(0,0,0,0.05); min-height: 60px; }
        .footer-player { display: flex; flex-direction: column; align-items: center; width: 45px; position: relative; transition: 0.3s; cursor: pointer; }
        .footer-avatar { width: 40px; height: 40px; transition: 0.3s; }
        .footer-name { font-size: 0.7rem; color: var(--text-main); font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; margin-top: 2px; }
        .status-check { position: absolute; top: -5px; right: -5px; background: var(--success); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: none; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 5; }
        .footer-player.done .status-check { display: flex; }
        .footer-player.done .footer-avatar { opacity: 0.6; transform: scale(0.9); filter: grayscale(50%); }
        #chat-toggle-btn { position: absolute; bottom: 20px; left: 20px; z-index: 100; background: var(--primary); color: white; border: none; width: 55px; height: 55px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4); transition: 0.3s; display: none; }
        .has-new-msg::after { content: ''; position: absolute; top: 2px; right: 2px; width: 14px; height: 14px; background: #ff7675; border-radius: 50%; border: 2px solid white; }
        #chat-popup { position: absolute; bottom: 85px; left: 20px; width: 300px; height: 45vh; background: var(--card-bg); border-radius: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; z-index: 101; transform: scale(0); transform-origin: bottom left; transition: 0.3s; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); } #chat-popup.open { transform: scale(1); }
        .chat-header { padding: 10px 15px; background: var(--primary); color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages-area { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: rgba(0,0,0,0.02); }
        
        /* ğŸ”¥ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø£ÙØ§ØªØ§Ø± */
        .chat-msg-row { display: flex; align-items: flex-end; margin-bottom: 12px; width: 100%; }
        .chat-msg-row.mine { flex-direction: row-reverse; } 
        .chat-msg-row.theirs { flex-direction: row; }
        .chat-avatar-small { width: 35px; height: 35px; border-radius: 50%; background: #fff; border: 1px solid #ccc; overflow: hidden; flex-shrink: 0; margin: 0 5px; }
        .chat-avatar-small svg { width: 100%; height: 100%; }
        .chat-content { display: flex; flex-direction: column; max-width: 75%; }
        .chat-sender { font-size: 0.65rem; color: #666; margin-bottom: 2px; font-weight: bold; text-align: right; }
        .chat-msg-row.mine .chat-sender { display: none; }
        .chat-bubble { padding: 8px 12px; font-size: 0.9rem; word-wrap: break-word; border-radius: 15px; position: relative; }
        .chat-msg-row.mine .chat-bubble { background: var(--primary); color: white; border-bottom-left-radius: 2px; } 
        .chat-msg-row.theirs .chat-bubble { background: var(--input-bg); color: var(--text-main); border-bottom-right-radius: 2px; }

        .chat-input-area { padding: 10px; background: var(--card-bg); border-top: 1px solid #eee; display: flex; gap: 5px; }
        .chat-input-area input { flex-grow: 1; padding: 8px; border-radius: 20px; border: 1px solid #ccc; outline: none; text-align: right; }
        .loser-box { background: rgba(255, 118, 117, 0.2); border: 2px dashed #ff7675; padding: 15px; border-radius: 25px; margin: 10px 0; display: flex; flex-direction: column; align-items: center; width: 100%; }
        #player-info-modal { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:200; display:none; justify-content:center; align-items:center; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s; }
        #player-info-modal.open { display:flex; opacity: 1; }
        .player-info-card { width: 85%; background: var(--card-bg); padding: 30px; border-radius: 30px; text-align: center; position: relative; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.8); } to { transform: scale(1); } }
        .social-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 12px; border-radius: 15px; color: white; font-weight: bold; margin-bottom: 10px; text-decoration: none; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .social-btn:active { transform: scale(0.98); }
        .social-btn.insta { background: var(--insta); } .social-btn.snap { background: var(--snap); color: black; }
        .social-btn.disabled { background: #eee; color: #aaa; pointer-events: none; box-shadow: none; }
        .kick-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.5; transition: 0.3s; padding: 5px; }
        .kick-btn:hover { opacity: 1; transform: scale(1.2); }
        .avatar-controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; margin-bottom: 20px; }
        .control-btn { background: var(--card-bg); color: var(--text-main); border: 2px solid #eee; padding: 12px 5px; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.2s; touch-action: manipulation; }
        .control-btn:active { transform: scale(0.95); background: #eee; }

        /* ğŸ”¥ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù„Ø±ÙØ¹ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© */
        #profile-screen .card-box {
            padding-top: 90px;
            position: relative;
            margin-top: 70px; 
            overflow: visible; 
        }
        #profile-avatar {
            position: absolute;
            top: -75px; 
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 150px;
            padding: 5px;
            border: 5px solid var(--card-bg);
            background: var(--bg-gradient);
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #profile-avatar svg { width: 100%; height: 100%; }
        #profile-name-display { margin: 15px 0 5px 0; }
        
        @media (max-width: 380px) { h1 { font-size: 2.2rem; } .btn { padding: 14px; font-size: 1rem; } .screen { padding: 15px; padding-top: 70px; } }
    </style>
</head>
<body>

<div id="app-container">
    <button class="top-btn theme-btn" onclick="toggleTheme()" title="ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¸Ù‡Ø±">ğŸŒ“</button>
    <button class="top-btn exit-btn" onclick="leaveGame()" title="Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©">ğŸšª</button>
    
    <div id="home-profile-btn" class="profile-circle-btn" onclick="showProfile()">
        <div id="home-btn-avatar" style="width:100%; height:100%;"></div>
    </div>

    <button id="chat-toggle-btn" onclick="toggleChat()">ğŸ’¬</button>
    
    <div id="chat-popup">
        <div class="chat-header"><span>Small Chat ğŸ˜œ</span><span class="chat-close" onclick="toggleChat()">Ã—</span></div>
        <div class="chat-messages-area" id="chat-msgs-box"></div>
        <div class="chat-input-area"><input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø´ÙŠ..." onkeypress="handleChatEnter(event)"><button class="chat-send-btn" style="background:var(--primary); color:white; border:none; width:35px; height:35px; border-radius:50%; cursor:pointer;" onclick="sendChatMessage()">â¤</button></div>
    </div>

    <div id="player-info-modal" onclick="closePlayerModal(event)">
        <div class="player-info-card">
            <div id="modal-avatar" class="home-avatar-box" style="margin: 0 auto 10px;"></div>
            <h2 id="modal-name" style="margin: 10px 0;">...</h2>
            <div id="modal-bio" style="font-size: 0.9rem; color: #666; margin-bottom: 20px; font-style: italic;"></div>
            <a id="modal-btn-insta" href="#" target="_blank" class="social-btn insta"><i class="fab fa-instagram"></i> Ù…ØªØ§Ø¨Ø¹Ø©</a>
            <a id="modal-btn-snap" href="#" target="_blank" class="social-btn snap"><i class="fab fa-snapchat-ghost"></i> Ø¥Ø¶Ø§ÙØ©</a>
            <button onclick="document.getElementById('player-info-modal').classList.remove('open')" class="btn btn-outline" style="margin-top: 10px;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="screen-reg" class="screen">
        <h2 style="font-size:2rem; margin-bottom:10px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¬Ø§Ø·Øª ğŸ‘‹</h2>
        <p style="margin-bottom:15px; opacity:0.7;">ØµÙ…Ù… Ø´Ø®ØµÙŠØªÙƒ Ø¹Ø´Ø§Ù† ØªØ¯Ø®Ù„</p>
        <div class="avatar-preview-box" id="reg-avatar-preview"></div>
        <div class="input-group"><input type="text" id="reg-name-input" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø± (Ù…Ø·Ù„ÙˆØ¨)" maxlength="12" style="border: 2px solid var(--primary);"></div>
        <p style="font-size:0.8rem; margin:5px 0; color:var(--text-main);">Ø­Ø· Ø­Ø³Ø§Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ğŸ‘‡</p>
        <div class="social-input"><i class="fab fa-instagram" style="color: #bc1888;"></i><input type="text" id="reg-insta-input" placeholder="Enter Instagram User"></div>
        <div class="social-input"><i class="fab fa-snapchat-ghost" style="color: #FFFC00; text-shadow: 0 0 2px #000;"></i><input type="text" id="reg-snap-input" placeholder=" Enter Snap User"></div>
        <div class="avatar-controls">
            <button class="control-btn" onclick="changeConfig('color')">ğŸ¨ Ù„ÙˆÙ†</button>
            <button class="control-btn" onclick="changeConfig('face')">ğŸ‘€ ÙˆØ¬Ù‡</button>
            <button class="control-btn" onclick="changeConfig('hat')">ğŸ© Ù‚Ø¨Ø¹Ø©</button>
        </div>
        <div class="btn-container"><button class="btn btn-primary" onclick="saveRegistration()">ğŸš€ Ø­ÙØ¸ ÙˆØ¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</button></div>
    </div>

    <div id="home-screen" class="screen active">
        <h1>Ø¬Ø§Ø·Øª ğŸ²</h1>
        <div id="my-avatar-home" class="home-avatar-box"></div>
        <div class="btn-container"><button class="btn btn-secondary" onclick="goToSetup()">ğŸ”’ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button><button class="btn btn-outline" onclick="showJoinCode()">ğŸ”‘ Ø¯Ø®ÙˆÙ„ Ø¨Ø±Ù…Ø²</button></div>
        <p id="reconnect-msg" style="display:none; color:var(--primary); margin-top:10px;">Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©... â³</p>
    </div>

    <div id="profile-screen" class="screen">
        <div class="card-box">
            <div id="profile-avatar"></div>

            <h2 id="profile-name-display">...</h2>
            <div style="background: var(--secondary); color: white; padding: 4px 15px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 15px;">Ù…Ø³ØªÙˆÙ‰ <span id="profile-lvl">1</span></div>
            
            <div class="social-input" style="margin-bottom:5px;"><i class="fab fa-instagram" style="color: #bc1888;"></i><input type="text" id="profile-insta-input" placeholder="Enter Instagram User" onblur="saveProfileData()"></div>
            <div class="social-input" style="margin-bottom:15px;"><i class="fab fa-snapchat-ghost" style="color: #FFFC00; text-shadow: 0 0 2px #000;"></i><input type="text" id="profile-snap-input" placeholder="Enter Snap User" onblur="saveProfileData()"></div>
            <div class="input-group" style="margin-bottom:10px;"><textarea id="profile-bio" placeholder="...Bio" onblur="saveProfileData()"></textarea></div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <div style="background: var(--input-bg); padding: 10px; border-radius: 10px;"><div style="font-size: 0.8rem; color: #888;">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ² ğŸ†</div><div id="profile-wins" style="font-size: 1.2rem; font-weight: bold; color: var(--success);">0</div></div>
                <div style="background: var(--input-bg); padding: 10px; border-radius: 10px;"><div style="font-size: 0.8rem; color: #888;">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· â­</div><div id="profile-points" style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">0</div></div>
            </div>
        </div>
        <div class="btn-container"><button class="btn btn-primary" onclick="goToEditVisuals()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø´ÙƒÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ©</button><button class="btn btn-outline" onclick="goHome()">Ø±Ø¬ÙˆØ¹</button></div>
    </div>

    <div id="screen-edit-visuals" class="screen">
        <h2>Ù†ÙŠÙˆ Ù„ÙˆÙƒ âœ¨</h2>
        <div class="avatar-preview-box" id="edit-avatar-preview"></div>
        <div class="input-group"><input type="text" id="edit-name-input" placeholder="ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…..." maxlength="12"></div>
        <div class="avatar-controls" style="grid-template-columns: repeat(3, 1fr);">
            <button class="control-btn" onclick="changeConfig('color')">ğŸ¨ Ù„ÙˆÙ†</button>
            <button class="control-btn" onclick="changeConfig('face')">ğŸ‘€ ÙˆØ¬Ù‡</button>
            <button class="control-btn" onclick="changeConfig('hat')">ğŸ© Ù‚Ø¨Ø¹Ø©</button>
        </div>
        <div class="btn-container"><button class="btn btn-primary" onclick="saveVisualsAndReturn()">Ø­ÙØ¸ âœ…</button></div>
    </div>

    <div id="name-input-screen" class="screen"><h2>Ù…Ù† Ø£Ù†ØªØŸ</h2><div class="input-group"><input type="text" id="public-name" placeholder="..."></div><button class="btn btn-outline" onclick="goHome()">Ø±Ø¬ÙˆØ¹</button></div>
    <div id="setup-screen" class="screen">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¬Ø§Ø·Øª âš™ï¸</h2>
        <div class="input-group"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª: <span id="rounds-display" style="color:var(--primary)">5</span></label><input type="range" id="rounds-setting" min="3" max="30" value="5" oninput="document.getElementById('rounds-display').innerText=this.value"></div>
        <div class="input-group"><label>ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: <span id="time-display" style="color:var(--primary)">30</span> Ø«Ø§Ù†ÙŠØ©</label><input type="range" id="time-setting" min="15" max="60" value="30" oninput="document.getElementById('time-display').innerText=this.value"></div>
        <div class="input-group"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: <span id="players-display" style="color:var(--primary)">8</span></label><input type="range" id="max-players" min="2" max="30" value="8" oninput="document.getElementById('players-display').innerText=this.value"></div>
        <div class="btn-container"><button class="btn btn-secondary" onclick="goToTopicsSetup()">Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ ğŸ“‹</button><button class="btn btn-outline" onclick="goHome()">Ø¥Ù„ØºØ§Ø¡</button></div>
    </div>
    <div id="topics-setup-screen" class="screen"><h2>Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ ğŸ“‚</h2><div class="topics-grid" id="topics-config-grid"></div><br><div class="btn-container"><button class="btn btn-primary" onclick="createRoom()">âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©</button><button class="btn btn-outline" onclick="showScreen('setup-screen')">Ø±Ø¬ÙˆØ¹</button></div></div>
    <div id="lobby-screen" class="screen">
        <div style="text-align:center; margin-bottom:20px;"><span style="font-size:0.9rem; opacity:0.7;">Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</span><div id="room-code-display" style="font-size:2.5rem; font-weight:900; color:var(--primary); letter-spacing:5px;">....</div><button onclick="copyInviteLink()" class="btn btn-outline" style="margin-top:10px; font-size:0.9rem; padding:8px;">ğŸ”— Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button></div>
        <h3 style="align-self:flex-start; margin-right:10px;">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ğŸ‘‡</h3><div class="lobby-list" id="lobby-players"></div>
        <div class="btn-container"><div id="host-start-btn" style="display:none; width:100%"><button class="btn btn-primary" onclick="startGameFlow()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨!</button></div><p id="guest-wait-msg" style="display:none; color: var(--primary);">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...</p></div>
    </div>
    <div id="topic-screen" class="screen"><h2 id="chooser-msg">...</h2><div class="topics-grid" id="topics-container"></div></div>
    <div id="game-screen" class="screen">
        <div class="timer-bar" id="game-timer"></div>
        <div class="question-box"><p id="question-text" style="color: var(--text-main); font-weight: 800; font-size: 1.3rem; margin: 0; line-height: 1.5;">...</p></div>
        <input type="text" id="answer-input" placeholder="Ø§ÙƒØªØ¨ ÙƒØ°Ø¨ØªÙƒ Ù‡Ù†Ø§...">
        <div id="truth-msg"></div>
        <div id="wait-msg-game" style="display:none; color:var(--text-main); margin-top:10px;">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ù‚ÙŠØ© â³</div>
        <button id="submit-ans-btn" class="btn btn-primary" style="margin-top: 15px;" onclick="submitAnswer()">Ø¥Ø±Ø³Ø§Ù„</button>
        <div id="game-players-footer" class="game-footer"></div>
    </div>
    <div id="vote-screen" class="screen"><h2>ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©ØŸ ğŸ¤”</h2><div id="vote-options" class="btn-container" style="margin-top:10px; margin-bottom:20px;"></div><div id="vote-players-footer" class="game-footer"></div></div>
    <div id="results-screen" class="screen">
        <div class="card-box" style="background:var(--success); color:white; border:none;"><span style="opacity:0.8; font-size:0.9rem;">Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ù‡ÙŠ:</span><h2 id="truth-display" style="color:white; margin:5px 0;">...</h2></div>
        <h3>ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬ÙˆÙ„Ø© ğŸ†</h3><div id="leaderboard-list" class="lobby-list" style="flex-grow:1; width:100%;"></div>
        <button id="next-round-btn" class="btn btn-primary" style="display:none; margin-top: 10px;" onclick="nextStep()">Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© â¡</button><p id="waiting-host-msg" style="display:none; margin-top:10px; color:var(--text-main)">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...</p>
    </div>
    <div id="gameover-screen" class="screen">
        <h1>ğŸ‰ Ø§Ù†ØªÙ‡Øª ğŸ‰</h1>
        <div style="display:flex; width:100%; gap:10px; justify-content:center;">
            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 20px; flex:1; display: flex; flex-direction: column; align-items: center;"><h3 style="margin:0; color:var(--success)">ğŸ† Ø§Ù„ÙØ§Ø¦Ø²</h3><div id="winner-avatar-display" class="winner-avatar-box"></div><h2 id="winner-name" style="color:var(--primary); margin: 0; font-size: 1.2rem;">...</h2><h3 id="winner-score" style="color:var(--accent); margin: 5px 0;">...</h3></div>
            <div class="loser-box" style="flex:1;"><h3 style="margin:0; color:#d63031">ğŸ’© Ø£ØºØ¨Ù‰ Ø´Ø®Øµ</h3><div id="loser-avatar-display" class="winner-avatar-box"></div><h2 id="loser-name" style="color:#d63031; margin: 0; font-size: 1.2rem;">...</h2><h3 id="loser-score" style="color:#d63031; margin: 5px 0;">...</h3></div>
        </div>
        <div class="btn-container" style="margin-top:20px;"><button id="restart-btn" class="btn btn-primary" style="display:none;" onclick="restartGame()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨</button><button class="btn btn-danger" onclick="exitGame()">ğŸ  Ø®Ø±ÙˆØ¬</button></div>
        <p id="gameover-wait-msg" style="display:none; color:var(--text-main)">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...</p>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    function toggleTheme() { document.body.classList.toggle('dark-theme'); }

    // === ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¢Ù…Ù† ===
    function safeRender(id, content) {
        const el = document.getElementById(id);
        if (el) el.innerHTML = content;
    }

    // === SVG Generator ===
    const colors = ['#FF9F43', '#54a0ff', '#5f27cd', '#ff6b6b', '#1dd1a1', '#feca57', '#fd79a8', '#00cec9', '#6D214F', '#2d3436', '#badc58', '#fab1a0', '#ffeaa7'];
    let avatarConfig = { color: 0, face: 0, hat: 0 };
    
    const hats = [ 
        `<g transform="translate(50, -5)"><path d="M-35 20 Q-45 5 -25 0" stroke="#3d3d3d" stroke-width="3" fill="#f1f2f6"/><path d="M35 20 Q45 5 25 0" stroke="#3d3d3d" stroke-width="3" fill="#f1f2f6"/><path d="M-25 30 Q-25 5 0 5 Q25 5 25 30" fill="#cd6133" stroke="#3d3d3d" stroke-width="3"/><path d="M-28 30 L28 30 L28 35 L-28 35 Z" fill="#b2bec3" stroke="#3d3d3d" stroke-width="3"/><path d="M-5 35 L-5 5 L5 5 L5 35 Z" fill="#b2bec3" stroke="#3d3d3d" stroke-width="3"/></g>`, 
        ``, 
        `<g transform="translate(50, -10)"><path d="M-20 25 L-20 5 L-10 20 L0 5 L10 20 L20 5 L20 25 Z" fill="#feca57" stroke="#3d3d3d" stroke-width="3"/></g>`, 
        `<g transform="translate(50, -15)"><rect x="-2" y="0" width="4" height="15" fill="#1dd1a1" stroke="#3d3d3d" stroke-width="2"/><circle cx="5" cy="20" r="10" fill="#ff6b6b" stroke="#3d3d3d" stroke-width="3"/><circle cx="-5" cy="22" r="10" fill="#ff6b6b" stroke="#3d3d3d" stroke-width="3"/></g>`, 
        `<g transform="translate(50, -10)"><path d="M-25 25 L25 25 L30 15 L-30 15 Z" fill="#2d3436" stroke="#3d3d3d" stroke-width="3"/><path d="M-25 15 Q-25 -5 0 -5 Q25 -5 25 15" fill="#0984e3" stroke="#3d3d3d" stroke-width="3"/><circle cx="0" cy="10" r="5" fill="#feca57"/></g>`, 
        `<g transform="translate(50, -20)"><rect x="-25" y="20" width="50" height="5" fill="#2d3436" stroke="#3d3d3d"/><path d="M-15 20 L-10 -10 L10 -10 L15 20 Z" fill="#2d3436" stroke="#3d3d3d" stroke-width="2"/><rect x="-15" y="15" width="30" height="5" fill="#d63031"/></g>`, 
        `<g transform="translate(50, -10)"><path d="M-35 15 Q0 25 35 15 L30 5 Q0 10 -30 5 Z" fill="#8B4513" stroke="#3d3d3d" stroke-width="2"/><rect x="-15" y="0" width="30" height="15" fill="#8B4513" stroke="#3d3d3d"/><rect x="-15" y="10" width="30" height="5" fill="#6D214F"/></g>`, 
        `<g transform="translate(50, 0)"><path d="M-30 30 Q-30 -10 30 30" fill="none" stroke="#3d3d3d" stroke-width="6"/><rect x="-38" y="20" width="12" height="25" rx="5" fill="#74b9ff" stroke="#3d3d3d" stroke-width="2"/><rect x="26" y="20" width="12" height="25" rx="5" fill="#74b9ff" stroke="#3d3d3d" stroke-width="2"/></g>`, 
        `<g transform="translate(50, -15)"><path d="M0 20 Q5 5 15 0 Q5 5 0 20 Q-5 5 -15 0 Q-5 5 0 20" fill="#badc58" stroke="#3d3d3d" stroke-width="2"/><rect x="-8" y="20" width="16" height="12" fill="#e17055" stroke="#3d3d3d" stroke-width="2"/></g>`,
        `<g transform="translate(50, 0)"><path d="M-22 5 Q-30 40 -15 50 L 15 50 Q 30 40 22 5 Q 0 -10 -22 5" fill="#4b3621" stroke="#3d3d3d" stroke-width="2"/></g>`,
        `<g transform="translate(50, -10)"><circle cx="0" cy="0" r="15" fill="#5d4037" stroke="#3d3d3d" stroke-width="2"/><path d="M-5 5 Q0 10 5 5" fill="none" stroke="#ff7675" stroke-width="3"/></g>`,
        `<g transform="translate(50, -5)"><path d="M-20 10 L-25 -5 L-10 5 Z" fill="#3d3d3d"/><path d="M20 10 L25 -5 L10 5 Z" fill="#3d3d3d"/></g>`
    ];
    
    const faces = [ 
        `<g transform="translate(50, 35)"><path d="M-20 0 Q-10 10 0 0 Z" fill="white" stroke="#3d3d3d" stroke-width="2.5" transform="translate(-10, 0)"/><path d="M-20 0 Q-10 10 0 0 Z" fill="white" stroke="#3d3d3d" stroke-width="2.5" transform="translate(25, 0)"/><circle cx="-18" cy="3" r="2" fill="black"/><circle cx="18" cy="3" r="2" fill="black"/><path d="M-15 20 L-10 15 L-5 20 L0 15 L5 20 L10 15 L15 20" fill="none" stroke="#3d3d3d" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></g>`, 
        `<g transform="translate(50, 40)"><circle cx="-15" cy="0" r="4" fill="black"/><circle cx="15" cy="0" r="4" fill="black"/><path d="M-5 10 Q0 15 5 10" fill="none" stroke="black" stroke-width="3" stroke-linecap="round"/></g>`, 
        `<g transform="translate(50, 40)"><circle cx="-15" cy="0" r="3" fill="black"/><circle cx="15" cy="0" r="3" fill="black"/><ellipse cx="0" cy="15" rx="5" ry="8" fill="black"/></g>`, 
        `<g transform="translate(50, 40)"><path d="M-25 -5 L-5 -5 L-5 5 L-20 10 Z" fill="black"/><path d="M25 -5 L5 -5 L5 5 L20 10 Z" fill="black"/><rect x="-5" y="-3" width="10" height="2" fill="black"/><path d="M-10 15 Q0 20 10 15" fill="none" stroke="black" stroke-width="3"/></g>`, 
        `<g transform="translate(50, 40)"><path d="M-20 0 L-10 -5 L0 0" fill="none" stroke="black" stroke-width="3"/><path d="M0 0 L10 -5 L20 0" fill="none" stroke="black" stroke-width="3"/><path d="M-10 15 Q0 25 10 15" fill="none" stroke="black" stroke-width="3"/></g>`, 
        `<g transform="translate(50, 42)"><circle cx="-15" cy="-5" r="3" fill="black"/><circle cx="15" cy="-5" r="3" fill="black"/><path d="M-5 10 Q-15 10 -20 0 Q-10 5 0 10 Q10 5 20 0 Q15 10 5 10 Z" fill="#2d3436" stroke="black" stroke-width="1"/></g>`, 
        `<g transform="translate(50, 38)"><circle cx="0" cy="5" r="14" fill="white" stroke="black" stroke-width="2"/><circle cx="0" cy="5" r="6" fill="black"/><path d="M-8 25 Q0 20 8 25" fill="none" stroke="black" stroke-width="3"/></g>`, 
        `<g transform="translate(50, 40)"><circle cx="-15" cy="0" r="3" fill="black"/><circle cx="15" cy="0" r="3" fill="black"/><path d="M-15 5 L-15 15" stroke="#74b9ff" stroke-width="3"/><path d="M15 5 L15 15" stroke="#74b9ff" stroke-width="3"/><path d="M-8 20 Q0 15 8 20" fill="none" stroke="black" stroke-width="3"/></g>`,
        `<g transform="translate(50, 40)"><circle cx="-12" cy="0" r="3" fill="black"/><path d="M-15 -3 L-18 -6 M-12 -3 L-12 -7" stroke="black" stroke-width="1.5"/><circle cx="12" cy="0" r="3" fill="black"/><path d="M15 -3 L18 -6 M12 -3 L12 -7" stroke="black" stroke-width="1.5"/><path d="M-5 10 Q0 13 5 10" fill="none" stroke="black" stroke-width="2"/></g>`,
        `<g transform="translate(50, 40)"><circle cx="-10" cy="0" r="5" fill="black"/><circle cx="-8" cy="-2" r="2" fill="white"/><circle cx="10" cy="0" r="5" fill="black"/><circle cx="12" cy="-2" r="2" fill="white"/><path d="M-2 8 Q0 6 2 8" fill="none" stroke="black" stroke-width="1.5"/></g>`,
        `<g transform="translate(50, 42)"><path d="M-12 0 L-8 4 L-4 0" fill="none" stroke="black" stroke-width="2"/><path d="M4 0 L8 4 L12 0" fill="none" stroke="black" stroke-width="2"/><ellipse cx="-12" cy="8" rx="4" ry="2" fill="#ff7675" opacity="0.6"/><ellipse cx="12" cy="8" rx="4" ry="2" fill="#ff7675" opacity="0.6"/></g>`
    ];

    function generateSVG(config) { 
        const color = colors[config.color % colors.length]; 
        const hat = hats[config.hat % hats.length] || ''; 
        const face = faces[config.face % faces.length]; 
        return `<svg viewBox="0 -30 100 150" xmlns="http://www.w3.org/2000/svg">
            <g transform="translate(0, 10)">
                <ellipse cx="50" cy="95" rx="30" ry="8" fill="rgba(0,0,0,0.15)" />
                <path d="M18 60 Q10 70 12 80 Q15 85 25 75" fill="${color}" stroke="#3d3d3d" stroke-width="3"/>
                <path d="M82 60 Q90 70 88 80 Q85 85 75 75" fill="${color}" stroke="#3d3d3d" stroke-width="3"/>
                <path d="M 25 30 Q 25 0 50 0 Q 75 0 75 30 L 75 70 Q 75 90 65 90 L 60 90 L 60 105 Q 60 110 50 110 Q 40 110 40 105 L 40 90 L 35 90 Q 25 90 25 70 Z" fill="${color}" stroke="#3d3d3d" stroke-width="3" stroke-linejoin="round"/>
                <ellipse cx="50" cy="45" rx="22" ry="18" fill="#ffdbac" stroke="#3d3d3d" stroke-width="0"/>
                ${face}
                ${hat}
            </g>
        </svg>`; 
    }

    function renderEditor() {
        const svg = generateSVG(avatarConfig);
        safeRender('avatar-editor-preview', svg);
        safeRender('reg-avatar-preview', svg);
        safeRender('edit-avatar-preview', svg);
        safeRender('my-avatar-home', svg);
        safeRender('home-btn-avatar', svg);
        safeRender('profile-avatar', svg);
        safeRender('modal-avatar', svg);
        safeRender('winner-avatar-display', svg);
        safeRender('loser-avatar-display', svg);
    }
    
    function changeConfig(type) { 
        if(type === 'color') avatarConfig.color++; 
        if(type === 'face') avatarConfig.face++; 
        if(type === 'hat') avatarConfig.hat++; 
        renderEditor(); 
    }
    
    // === Game Logic ===
    const socket = io();
    const sounds = { click: new Audio('sounds/click.mp3'), join: new Audio('sounds/join.mp3'), start: new Audio('sounds/start.mp3'), win: new Audio('sounds/win.mp3'), lose: new Audio('sounds/lose.mp3'), cheer: new Audio('sounds/cheer.mp3'), timer: new Audio('sounds/timer.mp3'), msg: new Audio('sounds/click.mp3') };
    function playSound(name) { try { if(sounds[name]) { sounds[name].currentTime=0; sounds[name].play().catch(e=>{}); } } catch(e){} }
    document.addEventListener('click', (e)=>{ if(e.target.tagName==='BUTTON'||e.target.classList.contains('vote-btn')) playSound('click'); });

    let currentRoomCode = null, myName = '', amIHost = false, timerSoundTimeout;
    let allPlayersData = [];
    let isEditingFromProfile = false;
    let userStats = { wins: 0, totalPoints: 0, gamesPlayed: 0, level: 1, bio: "", insta: "", snap: "" };

    function loadStats() { const saved = localStorage.getItem('jatt_stats'); if (saved) userStats = JSON.parse(saved); calculateLevel(); }
    function saveStats() { localStorage.setItem('jatt_stats', JSON.stringify(userStats)); }
    function saveBio() { userStats.bio = document.getElementById('profile-bio').value; saveStats(); }
    function saveProfileData() {
        userStats.bio = document.getElementById('profile-bio').value;
        userStats.insta = document.getElementById('profile-insta-input').value;
        userStats.snap = document.getElementById('profile-snap-input').value;
        saveStats();
    }
    function calculateLevel() { userStats.level = Math.floor(userStats.totalPoints / 50) + 1; }

    function showProfile() {
        loadStats(); calculateLevel();
        safeRender('profile-avatar', generateSVG(avatarConfig));
        document.getElementById('profile-name-display').innerText = myName || 'Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯';
        document.getElementById('profile-bio').value = userStats.bio || "";
        document.getElementById('profile-insta-input').value = userStats.insta || "";
        document.getElementById('profile-snap-input').value = userStats.snap || "";
        document.getElementById('profile-lvl').innerText = userStats.level;
        document.getElementById('profile-wins').innerText = userStats.wins;
        document.getElementById('profile-points').innerText = userStats.totalPoints;
        showScreen('profile-screen');
    }

    function goToEditVisuals() { 
        renderEditor(); 
        document.getElementById('edit-name-input').value = myName; 
        showScreen('screen-edit-visuals'); 
    }
    
    function saveVisualsAndReturn() { 
        const newName = document.getElementById('edit-name-input').value.trim();
        if(newName) { myName = newName; sessionStorage.setItem('player_name', myName); localStorage.setItem('jatt_saved_name', myName); }
        sessionStorage.setItem('avatar_config', JSON.stringify(avatarConfig)); 
        localStorage.setItem('jatt_saved_avatar', JSON.stringify(avatarConfig)); 
        showProfile(); 
    }
    
    function editProfileFromProfile() { isEditingFromProfile = true; document.getElementById('player-name-input').value = myName; renderEditor(); showScreen('screen-avatar'); }

    function saveRegistration() {
        const name = document.getElementById('reg-name-input').value.trim();
        const insta = document.getElementById('reg-insta-input').value.trim();
        const snap = document.getElementById('reg-snap-input').value.trim();

        if (!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙŠØ§ ÙÙ†Ø§Ù†!");
        if (!insta && !snap) return alert("Ù„Ø§Ø²Ù… ØªØ­Ø· Ø­Ø³Ø§Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (Ø³Ù†Ø§Ø¨ Ø£Ùˆ Ø§Ù†Ø³ØªØ§) Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±ÙÙƒ!");

        myName = name; userStats.insta = insta; userStats.snap = snap;
        sessionStorage.setItem('player_name', myName); sessionStorage.setItem('avatar_config', JSON.stringify(avatarConfig));
        localStorage.setItem('jatt_saved_name', myName); localStorage.setItem('jatt_saved_avatar', JSON.stringify(avatarConfig));
        saveStats();
        goHome();
    }

    const allTopics = [ {id:'sudanese', label:'Ø³ÙˆØ¯Ø§Ù†ÙŠØ§Øª', icon:'ğŸ‡¸ğŸ‡©'}, {id:'football', label:'ÙƒØ±Ø© Ù‚Ø¯Ù…', icon:'âš½'}, {id:'movies', label:'Ø§ÙÙ„Ø§Ù… ÙˆÙ…Ø³Ù„Ø³Ù„Ø§Øª', icon:'ğŸ¬'}, {id:'history', label:'ØªØ§Ø±ÙŠØ® ÙˆØ¢Ø¯Ø§Ø¨', icon:'ğŸ“œ'}, {id:'science', label:'Ø¹Ù„ÙˆÙ…', icon:'ğŸ§ª'}, {id:'geography', label:'Ø¯ÙˆÙ„ ÙˆØ¬ØºØ±Ø§ÙÙŠØ§', icon:'ğŸŒ'}, {id:'flags', label:'Ø§Ø¹Ù„Ø§Ù…', icon:'ğŸ'}, {id:'tech', label:'ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§', icon:'ğŸ’»'}, {id:'anime', label:'Ø§Ù†Ù…ÙŠ ÙˆÙƒØ±ØªÙˆÙ†', icon:'ğŸœ'}, {id:'arts', label:'Ø´Ù‡Ø±Ø© ÙˆÙÙ†ÙˆÙ†', icon:'ğŸ¨'}, {id:'variety', label:'Ù…Ù†ÙˆØ¹Ø§Øª', icon:'ğŸ²'}, {id:'math', label:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª (Ø°ÙƒØ§Ø¡)', icon:'â•'}, {id:'weird', label:'Ø§Ø³Ø¦Ù„Ø© ØºØ±ÙŠØ¨Ø©', icon:'ğŸ¤ª'}, {id:'guinness', label:'Ù…ÙˆØ³ÙˆØ¹Ø© ØºÙŠÙ†ÙŠØ³', icon:'ğŸ†'}, {id:'inventors', label:'Ù…Ø®ØªØ±Ø¹ÙŠÙ†', icon:'ğŸ’¡'}, {id:'songs', label:'Ø§ØºØ§Ù†ÙŠ', icon:'ğŸµ'} ];
    let selectedTopics = [];

    window.addEventListener('load', () => {
        loadStats();
        const urlParams = new URLSearchParams(window.location.search);
        const inviteCode = urlParams.get('join');
        const savedName = sessionStorage.getItem('player_name') || localStorage.getItem('jatt_saved_name');
        const savedAvatar = sessionStorage.getItem('avatar_config') || localStorage.getItem('jatt_saved_avatar');
        const savedRoom = sessionStorage.getItem('room_code');
        
        if (savedName) {
            myName = savedName; 
            if (savedAvatar) avatarConfig = JSON.parse(savedAvatar);
            renderEditor();
            if(document.getElementById('home-profile-btn')) document.getElementById('home-profile-btn').style.display = 'block';

            if (inviteCode) {
                socket.emit('join_room', { code: inviteCode, name: savedName, avatarConfig, social: { insta: userStats.insta, snap: userStats.snap } });
            } else if (savedRoom) {
                document.getElementById('reconnect-msg').style.display = 'block';
                setTimeout(() => { socket.emit('rejoin_game', { roomCode: savedRoom, name: savedName, avatarConfig, social: { insta: userStats.insta, snap: userStats.snap } }); }, 500);
            } else {
                goHome(); 
            }
        } else {
            showScreen('screen-reg');
            renderEditor();
            if(document.querySelector('.theme-btn')) document.querySelector('.theme-btn').style.display = 'none';
        }
    });

    function copyInviteLink() { const link = window.location.origin + '?join=' + currentRoomCode; navigator.clipboard.writeText(link).then(() => alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! Ø£Ø±Ø³Ù„Ù‡ Ù„Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ğŸ“²")); }
    function voteKick(targetId) { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØµÙˆÙŠØª Ù„Ø·Ø±Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ØŸ")) { socket.emit('vote_kick', { targetId }); } }
    socket.on('kicked_out', () => { alert("ØªÙ… Ø·Ø±Ø¯Ùƒ Ù…Ù† Ø§Ù„ØºØ±ÙØ© Ø¨Ù‚Ø±Ø§Ø± Ø§Ù„Ø£ØºÙ„Ø¨ÙŠØ© ğŸ‘¢"); exitGame(); });

    socket.on('rejoin_success', (stateData) => {
        document.getElementById('reconnect-msg').style.display = 'none';
        currentRoomCode = stateData.roomCode; myName = stateData.name; amIHost = stateData.isHost; allPlayersData = stateData.players;
        document.getElementById('chat-toggle-btn').style.display = 'block';
        restoreGameState(stateData);
    });

    function showPlayerInfo(pid) {
        const p = allPlayersData.find(pl => pl.id === pid);
        if(!p) return;
        safeRender('modal-avatar', generateSVG(p.avatarConfig));
        document.getElementById('modal-name').innerText = p.name;
        document.getElementById('modal-bio').innerText = p.social?.bio || "Ù„Ø§Ø¹Ø¨ ØºØ§Ù…Ø¶ ğŸ•µï¸â€â™‚ï¸";
        
        const instaBtn = document.getElementById('modal-btn-insta');
        if(p.social?.insta) { instaBtn.href = `https://instagram.com/${p.social.insta}`; instaBtn.classList.remove('disabled'); instaBtn.innerHTML = '<i class="fab fa-instagram"></i> Ù…ØªØ§Ø¨Ø¹Ø©'; } 
        else { instaBtn.classList.add('disabled'); instaBtn.innerHTML = 'ØºÙŠØ± Ø±Ø§Ø¨Ø· Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù…'; }

        const snapBtn = document.getElementById('modal-btn-snap');
        if(p.social?.snap) { snapBtn.href = `https://snapchat.com/add/${p.social.snap}`; snapBtn.classList.remove('disabled'); snapBtn.innerHTML = '<i class="fab fa-snapchat-ghost"></i> Ø¥Ø¶Ø§ÙØ©'; } 
        else { snapBtn.classList.add('disabled'); snapBtn.innerHTML = 'ØºÙŠØ± Ø±Ø§Ø¨Ø· Ø³Ù†Ø§Ø¨'; }

        document.getElementById('player-info-modal').classList.add('open');
    }
    function closePlayerModal(e) { if(e.target.id === 'player-info-modal') document.getElementById('player-info-modal').classList.remove('open'); }

    function updateLobbyUI(data) {
        if(document.getElementById('lobby-players').children.length < data.players.length) playSound('join');
        currentRoomCode = data.code; saveSessionData();
        document.getElementById('chat-toggle-btn').style.display = 'block';
        showScreen('lobby-screen');
        document.getElementById('room-code-display').innerText = data.code;
        const list = document.getElementById('lobby-players'); list.innerHTML = '';
        amIHost = (socket.id === data.hostId || (data.players.find(p=>p.id===socket.id)?.isHost));
        allPlayersData = data.players;
        data.players.forEach(p => {
            const isMe = p.id === socket.id;
            const kickBtn = (!isMe) ? `<button class="kick-btn" onclick="event.stopPropagation(); voteKick('${p.id}')" title="ØªØµÙˆÙŠØª Ù„Ù„Ø·Ø±Ø¯">ğŸ‘¢</button>` : '';
            list.innerHTML += `<div class="player-chip" onclick="showPlayerInfo('${p.id}')">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div class="mini-avatar">${generateSVG(p.avatarConfig||{color:0})}</div>
                    <span>${p.name} ${p.isHost?'ğŸ‘‘':''}</span>
                </div>
                ${kickBtn}
            </div>`;
        });
        if (amIHost) { document.getElementById('host-start-btn').style.display='block'; document.getElementById('guest-wait-msg').style.display='none'; } else { document.getElementById('host-start-btn').style.display='none'; document.getElementById('guest-wait-msg').style.display='block'; }
    }

    function renderFooterPlayers(containerId, players, doneIds = []) {
        const footer = document.getElementById(containerId); if (!footer) return; footer.innerHTML = '';
        players.forEach(p => {
            const svg = generateSVG(p.avatarConfig || {color:0}); const isDone = doneIds.includes(p.id) ? 'done' : '';
            footer.innerHTML += `<div class="footer-player ${isDone}" id="${containerId}-fp-${p.id}" data-pid="${p.id}" onclick="showPlayerInfo('${p.id}')"><div class="footer-avatar mini-avatar">${svg}</div><div class="status-check">âœ”</div><div class="footer-name">${p.name}</div></div>`;
        });
    }

    socket.on('player_left_update', (updatedPlayers) => { allPlayersData = updatedPlayers; renderFooterPlayers('game-players-footer', allPlayersData); renderFooterPlayers('vote-players-footer', allPlayersData); });

    function restoreGameState(data) {
        if (data.gameState === 'lobby') { showScreen('lobby-screen'); updateLobbyUI({ code: data.roomCode, players: data.players, hostId: data.hostId }); }
        else if (data.gameState === 'picking_topic') { showScreen('topic-screen'); handleTopicPhase(data.topicData); }
        else if (data.gameState === 'input') {
            showScreen('game-screen'); document.getElementById('question-text').innerHTML = data.questionData.question;
            const inputField = document.getElementById('answer-input'); inputField.value = '';
            if(data.questionData.inputType === 'number') { inputField.type = 'number'; inputField.placeholder = "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…..."; } else { inputField.type = 'text'; inputField.placeholder = "Ø£Ù„Ù ÙƒØ°Ø¨Ø©..."; }
            renderFooterPlayers('game-players-footer', data.players, data.donePlayers);
            if(data.hasAnswered) { document.getElementById('wait-msg-game').style.display='block'; document.getElementById('submit-ans-btn').style.display='none'; } else { document.getElementById('wait-msg-game').style.display='none'; document.getElementById('submit-ans-btn').style.display='block'; }
        } else if (data.gameState === 'voting') { 
            showScreen('vote-screen'); renderVotingOptions(data.voteOptions); renderFooterPlayers('vote-players-footer', data.players, data.votedPlayers);
            if(data.hasVoted) document.querySelectorAll('.vote-btn').forEach(b => b.disabled = true);
        } else if (data.gameState === 'results') { showResultsUI(data.resultData); }
    }

    function saveSessionData() { sessionStorage.setItem('room_code', currentRoomCode); sessionStorage.setItem('player_name', myName); sessionStorage.setItem('avatar_config', JSON.stringify(avatarConfig)); }
    function clearSessionData() { sessionStorage.removeItem('room_code'); }
    
    function showScreen(id) { 
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        const exitBtn = document.querySelector('.exit-btn');
        const homeProfileBtn = document.getElementById('home-profile-btn');
        const themeBtn = document.querySelector('.theme-btn');
        
        if (id === 'home-screen') { if(exitBtn) exitBtn.style.display = 'none'; if(homeProfileBtn) homeProfileBtn.style.display = 'block'; if(themeBtn) themeBtn.style.display = 'block'; }
        else { if(homeProfileBtn) homeProfileBtn.style.display = 'none'; if (id === 'screen-avatar' || id === 'screen-reg' || id === 'screen-edit-visuals' || id === 'profile-screen' || id === 'name-input-screen' || id === 'setup-screen' || id === 'topics-setup-screen') { if(exitBtn) exitBtn.style.display = 'none'; } else { if(exitBtn) exitBtn.style.display = 'block'; } }
    }

    function goHome() { localStorage.setItem('jatt_saved_name', myName); localStorage.setItem('jatt_saved_avatar', JSON.stringify(avatarConfig)); showScreen('home-screen'); renderEditor(); }
    function joinPublic() { showScreen('name-input-screen'); }
    function goToSetup() { if(!myName) return alert("ØµÙ…Ù… Ø´Ø®ØµÙŠØªÙƒ Ø£ÙˆÙ„Ø§Ù‹!"); showScreen('setup-screen'); }
    function goToTopicsSetup() { const grid = document.getElementById('topics-config-grid'); grid.innerHTML = ''; allTopics.forEach(t => { const div = document.createElement('div'); div.className = 'topic-card selected'; div.innerText = t.icon+' '+t.label; div.dataset.id = t.id; div.onclick = () => div.classList.toggle('selected'); grid.appendChild(div); }); showScreen('topics-setup-screen'); }
    function createRoom() { selectedTopics = []; document.querySelectorAll('#topics-config-grid .selected').forEach(el => selectedTopics.push(el.dataset.id)); if(selectedTopics.length === 0) return alert("Ø§Ø®ØªØ± Ù…ÙˆØ¶ÙˆØ¹Ø§Ù‹!"); socket.emit('create_private_room', { name: myName, avatarConfig, social: { insta: userStats.insta, snap: userStats.snap } }); }
    function showJoinCode() { let code = prompt("Ø§Ù„ÙƒÙˆØ¯:"); if(code) socket.emit('join_room', { code, name: myName, avatarConfig, social: { insta: userStats.insta, snap: userStats.snap } }); }
    socket.on('go_to_setup', (code) => { currentRoomCode = code; saveSessionData(); document.getElementById('chat-toggle-btn').style.display = 'block'; socket.emit('save_settings', { roomCode: code, settings: { rounds: document.getElementById('rounds-setting').value, time: document.getElementById('time-setting').value, maxPlayers: document.getElementById('max-players').value, topics: selectedTopics } }); });
    socket.on('update_lobby', (data) => updateLobbyUI(data));
    function startGameFlow() { socket.emit('start_game_flow', currentRoomCode); }
    socket.on('choose_topic_phase', (data) => { showScreen('topic-screen'); handleTopicPhase(data); });
    function handleTopicPhase(data) { const cont = document.getElementById('topics-container'); cont.innerHTML = ''; if (socket.id === data.chooserId) { document.getElementById('chooser-msg').innerText = "Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹"; data.availableTopics.forEach(tid => { const t = allTopics.find(x => x.id === tid); if(t) { const btn = document.createElement('div'); btn.className = 'topic-card'; btn.innerText = t.icon+' '+t.label; btn.onclick = () => socket.emit('topic_selected', { roomCode: currentRoomCode, topic: tid }); cont.appendChild(btn); } }); } else document.getElementById('chooser-msg').innerText = `${data.chooserName} ÙŠØ®ØªØ§Ø±...`; }
    socket.on('start_round', (data) => { playSound('start'); showScreen('game-screen'); document.getElementById('question-text').innerHTML = data.question; const inputField = document.getElementById('answer-input'); inputField.value = ''; if(data.inputType === 'number') { inputField.type = 'number'; inputField.placeholder = "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…..."; } else { inputField.type = 'text'; inputField.placeholder = "Ø§ÙƒØªØ¨ ÙƒØ°Ø¨ØªÙƒ Ù‡Ù†Ø§..."; } document.getElementById('truth-msg').style.display = 'none'; document.getElementById('wait-msg-game').style.display = 'none'; document.getElementById('submit-ans-btn').style.display = 'block'; renderFooterPlayers('game-players-footer', allPlayersData); const bar = document.getElementById('game-timer'); bar.style.transition = 'none'; bar.style.width = '100%'; clearTimeout(timerSoundTimeout); sounds.timer.pause(); sounds.timer.currentTime=0; setTimeout(() => { bar.style.transition = `width ${data.time}s linear`; bar.style.width = '0%'; if(data.time > 5) timerSoundTimeout = setTimeout(() => playSound('timer'), (data.time-5)*1000); }, 100); });
    function submitAnswer() { const ans = document.getElementById('answer-input').value; if(ans) socket.emit('submit_answer', { roomCode: currentRoomCode, answer: ans }); }
    socket.on('player_done', (id) => { const elGame = document.getElementById(`game-players-footer-fp-${id}`); if(elGame) elGame.classList.add('done'); });
    socket.on('player_voted', (id) => { const elVote = document.getElementById(`vote-players-footer-fp-${id}`); if(elVote) elVote.classList.add('done'); });
    socket.on('truth_detected', (msg) => { playSound('win'); document.getElementById('truth-msg').innerText=msg; document.getElementById('truth-msg').style.display='block'; });
    socket.on('wait_for_others', () => { document.getElementById('wait-msg-game').style.display='block'; document.getElementById('submit-ans-btn').style.display='none'; });
    socket.on('voting_phase', (data) => { clearTimeout(timerSoundTimeout); sounds.timer.pause(); sounds.timer.currentTime=0; showScreen('vote-screen'); renderVotingOptions(data.options); renderFooterPlayers('vote-players-footer', allPlayersData); });
    function renderVotingOptions(options) { const list = document.getElementById('vote-options'); list.innerHTML = ''; options.forEach(opt => { const btn = document.createElement('button'); btn.className = 'vote-btn'; btn.innerText = opt.text; btn.onclick = () => { socket.emit('submit_vote', { roomCode: currentRoomCode, choiceData: opt }); document.querySelectorAll('.vote-btn').forEach(b => b.disabled = true); btn.style.borderColor='var(--primary)'; btn.style.color='var(--primary)'; }; list.appendChild(btn); }); }
    socket.on('show_results', (data) => showResultsUI(data));
    function showResultsUI(data) { showScreen('results-screen'); document.getElementById('truth-display').innerText = data.truth; const list = document.getElementById('leaderboard-list'); list.innerHTML = ''; let myPointsChange = 0; data.leaderboard.forEach((p, i) => { if(p.id === socket.id) myPointsChange = p.lastPoints; const gain = p.lastPoints > 0 ? `<span style="color:var(--success)">+${p.lastPoints}</span>` : ''; const svg = generateSVG(p.avatarConfig || {color:0}); list.innerHTML += `<div class="leaderboard-item" onclick="showPlayerInfo('${p.id}')"><div style="display:flex; align-items:center; gap:10px;"><b>#${i+1}</b><div class="mini-avatar">${svg}</div><span>${p.name}</span></div><div>${gain} <b>${p.score}</b></div></div>`; }); if(myPointsChange > 0) { playSound('win'); myCurrentSessionScore += myPointsChange; } else playSound('lose'); const btn = document.getElementById('next-round-btn'); const wait = document.getElementById('waiting-host-msg'); const isHostNow = (socket.id === data.hostId); if(isHostNow) { btn.style.display = 'block'; wait.style.display = 'none'; btn.innerText = data.isFinal ? "ğŸ”¥ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ§Ø¦Ø²" : "Ø§Ù„ØªØ§Ù„ÙŠ â¡"; btn.onclick = () => socket.emit('next_step', currentRoomCode); } else { btn.style.display = 'none'; wait.style.display = 'block'; wait.innerText = data.isFinal ? "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬..." : "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ..."; } }
    socket.on('game_over', (data) => { clearSessionData(); playSound('cheer'); showScreen('gameover-screen'); confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } }); document.getElementById('winner-name').innerText = data.winner.name; document.getElementById('winner-score').innerText = `${data.winner.score} Ù†Ù‚Ø·Ø©`; safeRender('winner-avatar-display', generateSVG(data.winner.avatarConfig || {color:0})); document.getElementById('loser-name').innerText = data.loser.name; document.getElementById('loser-score').innerText = `${data.loser.score} Ù†Ù‚Ø·Ø©`; safeRender('loser-avatar-display', generateSVG(data.loser.avatarConfig || {color:0})); userStats.gamesPlayed++; userStats.totalPoints += myCurrentSessionScore; if (data.winner.id === socket.id) userStats.wins++; calculateLevel(); saveStats(); myCurrentSessionScore = 0; const rBtn = document.getElementById('restart-btn'); const wMsg = document.getElementById('gameover-wait-msg'); const isHostNow = (socket.id === data.hostId); if(isHostNow) { rBtn.style.display = 'block'; wMsg.style.display = 'none'; } else { rBtn.style.display = 'none'; wMsg.style.display = 'block'; } });
    function restartGame() { socket.emit('restart_game', currentRoomCode); }
    function leaveGame() { if(!currentRoomCode) return goHome(); if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙƒ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©.")) { socket.emit('leave_game', currentRoomCode); sessionStorage.removeItem('room_code'); currentRoomCode = null; document.getElementById('chat-toggle-btn').style.display = 'none'; document.querySelector('.exit-btn').style.display = 'none'; location.reload(); } }
    function exitGame() { sessionStorage.removeItem('room_code'); location.reload(); }
    socket.on('error_msg', msg => alert(msg));
    function toggleChat() { document.getElementById('chat-popup').classList.toggle('open'); document.getElementById('chat-toggle-btn').classList.remove('has-new-msg'); if(document.getElementById('chat-popup').classList.contains('open')) { document.getElementById('chat-input').focus(); } }
    function sendChatMessage() { const inp = document.getElementById('chat-input'); const msg = inp.value.trim(); if(msg && currentRoomCode) { socket.emit('send_chat', { roomCode: currentRoomCode, message: msg }); inp.value = ''; } }
    function handleChatEnter(e) { if(e.key === 'Enter') sendChatMessage(); }

    // ğŸ”¥ğŸ”¥ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø§Øª Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø£ÙØ§ØªØ§Ø±
    socket.on('receive_chat', (data) => { 
        const box = document.getElementById('chat-msgs-box'); 
        const isMine = data.senderId === socket.id; 
        
        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙØ§ØªØ§Ø± Ù„Ù„Ø´Ø§Øª
        const avatarSVG = generateSVG(data.avatarConfig || {color:0});

        const div = document.createElement('div'); 
        div.className = `chat-msg-row ${isMine ? 'mine' : 'theirs'}`; 
        div.innerHTML = `
            <div class="chat-avatar-small">${avatarSVG}</div>
            <div class="chat-content">
                ${!isMine ? `<div class="chat-sender">${data.senderName}</div>` : ''}
                <div class="chat-bubble">${data.message}</div>
            </div>
        `; 
        box.appendChild(div); 
        box.scrollTop = box.scrollHeight; 
        if(!document.getElementById('chat-popup').classList.contains('open')) { 
            document.getElementById('chat-toggle-btn').classList.add('has-new-msg'); 
            playSound('msg'); 
        } 
    });
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
    renderEditor();
</script>
</body>
</html>